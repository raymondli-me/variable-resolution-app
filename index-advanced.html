<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https: file:; media-src 'self' file:; connect-src 'self' https:">
  <title>VR Data Collector</title>
  <link rel="stylesheet" href="src/styles/main.css">
  <link rel="stylesheet" href="src/styles/advanced.css">
  <link rel="stylesheet" href="src/styles/status.css">
    <link rel="stylesheet" href="src/styles/tool-installer.css">
    <link rel="stylesheet" href="src/styles/collections.css">
    <link rel="stylesheet" href="src/styles/collection-viewer.css">
    <link rel="stylesheet" href="src/styles/rating-projects.css">
    <link rel="stylesheet" href="src/styles/merged-collections.css">
    <link rel="stylesheet" href="src/styles/folder-browser.css">
    <link rel="stylesheet" href="src/styles/pdf-excerpt-viewer.css">
    <link rel="stylesheet" href="src/styles/pdf-renderer.css">
    <link rel="stylesheet" href="src/styles/collections-hub.css">
  </head>
<body>
  <div id="app">
    <!-- Header -->
    <header class="header">
      <h1>Variable Resolution Data Collector</h1>
      <div class="header-actions">
        <button id="openOutputHeaderBtn" class="btn btn-icon" title="Open output folder">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"></path>
          </svg>
        </button>
        <button id="settingsBtn" class="btn btn-icon" title="Settings">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M12 1v6m0 6v6m4.22-10.22l1.42-1.42m-1.42 10.88l1.42 1.42M20 12h-6m-6 0H2m10.22-4.22L10.8 6.36m1.42 10.88l-1.42 1.42"></path>
          </svg>
        </button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Sidebar -->
      <aside class="sidebar">
        <nav class="nav">
          <button class="nav-item active" data-view="collections">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
            </svg>
            Collections
          </button>
          <button class="nav-item" data-view="export">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Export
          </button>
        </nav>
      </aside>

      <!-- Content Area -->
      <section class="content">
        <!-- YouTube View -->
        <div id="youtubeView" class="view">
          <!-- Tab Navigation -->
          <div class="tabs">
            <button class="tab-btn active" data-tab="basic">Basic Search</button>
            <button class="tab-btn" data-tab="advanced">Advanced Options</button>
            <button class="tab-btn" data-tab="extraction">Data Extraction</button>
          </div>

          <!-- Basic Search Tab -->
          <div id="basicTab" class="tab-content active">
            <div class="search-section">
              <h2>YouTube Data Collection</h2>
              <div class="search-form">
                <div class="form-group">
                  <label for="searchTerm">Search Term</label>
                  <input type="text" id="searchTerm" placeholder="e.g., ADHD, mental health, climate change" />
                  <small>Enter keywords to search for YouTube videos</small>
                </div>
                
                <div class="form-row">
                  <div class="form-group">
                    <label for="maxResults">Max Videos</label>
                    <input type="number" id="maxResults" min="1" max="500" value="50" />
                    <small>Number of videos to search for</small>
                  </div>
                  
                  <div class="form-group">
                    <label for="dateRange">Date Range</label>
                    <select id="dateRange">
                      <option value="all">All Time</option>
                      <option value="today">Today</option>
                      <option value="week">This Week</option>
                      <option value="month" selected>This Month</option>
                      <option value="year">This Year</option>
                      <option value="custom">Custom Range</option>
                    </select>
                  </div>
                </div>

                <div class="form-group">
                  <label for="orderBy">Order By</label>
                  <select id="orderBy">
                    <option value="relevance">Relevance</option>
                    <option value="date">Upload Date</option>
                    <option value="viewCount" selected>View Count</option>
                    <option value="rating">Rating</option>
                    <option value="title">Title (A-Z)</option>
                  </select>
                  <small>How to sort search results</small>
                </div>

                <button id="searchBtn" class="btn btn-primary">
                  Search YouTube
                </button>
              </div>
            </div>
          </div>

          <!-- Advanced Options Tab -->
          <div id="advancedTab" class="tab-content">
            <div class="advanced-section">
              <h2>Advanced Search Options</h2>
              
              <div class="option-group">
                <h3>Video Filters</h3>
                <div class="form-row">
                  <div class="form-group">
                    <label for="videoDuration">Video Duration</label>
                    <select id="videoDuration">
                      <option value="any">Any Duration</option>
                      <option value="short">< 4 minutes</option>
                      <option value="medium">4-20 minutes</option>
                      <option value="long">> 20 minutes</option>
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="videoDefinition">Video Quality</label>
                    <select id="videoDefinition">
                      <option value="any">Any Quality</option>
                      <option value="high">HD Only</option>
                      <option value="standard">Standard</option>
                    </select>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="minViews">Minimum Views</label>
                    <input type="number" id="minViews" placeholder="e.g., 10000" />
                  </div>
                  
                  <div class="form-group">
                    <label for="maxViews">Maximum Views</label>
                    <input type="number" id="maxViews" placeholder="e.g., 1000000" />
                  </div>
                </div>

                <div class="form-group">
                  <label for="videoLanguage">Video Language</label>
                  <select id="videoLanguage">
                    <option value="">Any Language</option>
                    <option value="en" selected>English</option>
                    <option value="es">Spanish</option>
                    <option value="fr">French</option>
                    <option value="de">German</option>
                    <option value="ja">Japanese</option>
                    <option value="ko">Korean</option>
                    <option value="zh">Chinese</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="channelType">Channel Type</label>
                  <select id="channelType">
                    <option value="any">Any Channel</option>
                    <option value="show">TV Shows</option>
                    <option value="movie">Movies</option>
                  </select>
                </div>

                <div class="form-group checkbox-group">
                  <label>
                    <input type="checkbox" id="embeddable" />
                    <span>Embeddable videos only</span>
                  </label>
                  <small>Videos that can be played outside YouTube</small>
                </div>

                <div class="form-group checkbox-group">
                  <label>
                    <input type="checkbox" id="syndicated" checked />
                    <span>Include syndicated videos</span>
                  </label>
                  <small>Videos that can be played outside youtube.com</small>
                </div>
              </div>

              <div class="option-group">
                <h3>API Configuration</h3>
                <div class="form-group">
                  <label for="apiQuotaLimit">API Quota Limit</label>
                  <input type="number" id="apiQuotaLimit" value="1000" min="1" max="10000" />
                  <small>Stop collection when this many API units are used</small>
                </div>

                <div class="form-group">
                  <label for="rateLimitDelay">Rate Limit Delay (ms)</label>
                  <input type="number" id="rateLimitDelay" value="500" min="0" max="5000" />
                  <small>Delay between API requests to avoid rate limits</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Data Extraction Tab -->
          <div id="extractionTab" class="tab-content">
            <div class="extraction-section">
              <h2>Data Extraction Settings</h2>
              
              <div class="option-group">
                <h3>Video Metadata</h3>
                <div class="checkbox-list">
                  <label class="checkbox-item">
                    <input type="checkbox" id="extractTitle" checked />
                    <span>Title</span>
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" id="extractDescription" checked />
                    <span>Full Description</span>
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" id="extractTags" checked />
                    <span>Tags</span>
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" id="extractThumbnails" checked />
                    <span>Thumbnails (all resolutions)</span>
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" id="extractCaptions" />
                    <span>Closed Captions/Subtitles</span>
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" id="extractStatistics" checked />
                    <span>Statistics (views, likes, etc.)</span>
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" id="extractPublishDate" checked />
                    <span>Publish Date & Time</span>
                  </label>
                </div>
              </div>

              <div class="option-group">
                <h3>Channel Information</h3>
                <div class="checkbox-list">
                  <label class="checkbox-item">
                    <input type="checkbox" id="extractChannelTitle" checked />
                    <span>Channel Name</span>
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" id="extractChannelId" checked />
                    <span>Channel ID</span>
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" id="extractChannelStats" />
                    <span>Channel Statistics</span>
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" id="extractChannelDescription" />
                    <span>Channel Description</span>
                  </label>
                </div>
              </div>

              <div class="option-group">
                <h3>Comment Settings</h3>
                <div class="form-group checkbox-group">
                  <label>
                    <input type="checkbox" id="includeComments" checked />
                    <span>Extract Comments</span>
                  </label>
                </div>
                
                <div id="commentOptions" class="sub-options">
                  <div class="form-row">
                    <div class="form-group">
                      <label for="maxComments">Max Comments per Video</label>
                      <input type="number" id="maxComments" min="1" max="10000" value="100" />
                    </div>
                    
                    <div class="form-group">
                      <label for="commentSort">Comment Sort Order</label>
                      <select id="commentSort">
                        <option value="relevance">Relevance</option>
                        <option value="time">Newest First</option>
                      </select>
                    </div>
                  </div>

                  <div class="form-group">
                    <label for="minCommentLikes">Min Comment Likes</label>
                    <input type="number" id="minCommentLikes" placeholder="0" value="0" />
                    <small>Only collect comments with at least this many likes</small>
                  </div>

                  <div class="checkbox-list">
                    <label class="checkbox-item">
                      <input type="checkbox" id="includeReplies" />
                      <span>Include Reply Threads</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" id="commentAuthorChannelId" checked />
                      <span>Comment Author Channel ID</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" id="commentTimestamps" checked />
                      <span>Comment Timestamps</span>
                    </label>
                  </div>
                </div>
              </div>

              <div class="option-group">
                <h3>Video File Download</h3>
                <div class="form-group checkbox-group">
                  <label>
                    <input type="checkbox" id="downloadVideo" />
                    <span>Download Video Files</span>
                  </label>
                </div>
                
                <div id="downloadOptions" class="sub-options" style="display: none;">
                  <div class="form-row">
                    <div class="form-group">
                      <label for="videoQuality">Video Quality</label>
                      <select id="videoQuality">
                        <option value="lowest">Lowest Quality (fast)</option>
                        <option value="360p">360p</option>
                        <option value="480p" selected>480p</option>
                        <option value="720p">720p HD</option>
                        <option value="1080p">1080p Full HD</option>
                        <option value="highest">Highest Available</option>
                      </select>
                    </div>
                    
                    <div class="form-group">
                      <label for="videoFormat">Video Format</label>
                      <select id="videoFormat">
                        <option value="mp4" selected>MP4</option>
                        <option value="webm">WebM</option>
                        <option value="any">Best Available</option>
                      </select>
                    </div>
                  </div>

                  <div class="form-group">
                    <label for="maxFileSize">Max File Size (MB)</label>
                    <input type="number" id="maxFileSize" value="500" min="10" max="5000" />
                    <small>Skip videos larger than this size</small>
                  </div>

                  <div class="checkbox-list">
                    <label class="checkbox-item">
                      <input type="checkbox" id="extractAudioOnly" />
                      <span>Extract Audio Only</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" id="downloadThumbnail" checked />
                      <span>Download Thumbnail Image</span>
                    </label>
                  </div>
                </div>
              </div>

              <div class="option-group">
                <h3>Processing Options</h3>
                <div class="form-group">
                  <label for="textProcessing">Text Processing</label>
                  <select id="textProcessing">
                    <option value="none">No Processing</option>
                    <option value="clean">Clean Text (remove emojis, links)</option>
                    <option value="sentiment">Include Sentiment Analysis</option>
                  </select>
                </div>

                <div class="form-group checkbox-group">
                  <label>
                    <input type="checkbox" id="skipDuplicates" checked />
                    <span>Skip duplicate videos</span>
                  </label>
                  <small>Based on video ID</small>
                </div>

                <div class="form-group checkbox-group">
                  <label>
                    <input type="checkbox" id="continueOnError" checked />
                    <span>Continue on errors</span>
                  </label>
                  <small>Don't stop collection if one video fails</small>
                </div>
              </div>

              <div class="option-group">
                <h3>Transcription Settings (Optional)</h3>
                <div class="form-group checkbox-group">
                  <label>
                    <input type="checkbox" id="enableTranscription" />
                    <span>Enable Whisper Transcription</span>
                  </label>
                  <small class="transcription-status" id="transcriptionStatus">Checking availability...</small>
                </div>
                
                <div id="transcriptionOptions" class="sub-options" style="display: none;">
                  <div class="form-row">
                    <div class="form-group">
                      <label for="whisperModel">Whisper Model</label>
                      <select id="whisperModel">
                        <option value="tiny">Tiny (39M, fastest)</option>
                        <option value="base" selected>Base (74M, balanced)</option>
                        <option value="small">Small (244M, better)</option>
                        <option value="medium">Medium (769M, good)</option>
                        <option value="large">Large (1550M, best)</option>
                      </select>
                    </div>
                    
                    <div class="form-group">
                      <label for="whisperDevice">Processing Device</label>
                      <select id="whisperDevice">
                        <option value="auto" selected>Auto-detect</option>
                        <option value="cuda">NVIDIA GPU (CUDA)</option>
                        <option value="mps">Apple Silicon (Metal)</option>
                        <option value="cpu">CPU Only</option>
                      </select>
                    </div>
                  </div>

                  <div class="form-group">
                    <label for="whisperLanguage">Language</label>
                    <select id="whisperLanguage">
                      <option value="auto">Auto-detect</option>
                      <option value="en" selected>English</option>
                      <option value="es">Spanish</option>
                      <option value="fr">French</option>
                      <option value="de">German</option>
                      <option value="ja">Japanese</option>
                      <option value="ko">Korean</option>
                      <option value="zh">Chinese</option>
                    </select>
                  </div>

                  <div class="form-group checkbox-group">
                    <label>
                      <input type="checkbox" id="whisperTimestamps" checked />
                      <span>Include word-level timestamps</span>
                    </label>
                  </div>
                  
                  <div class="form-group checkbox-group">
                    <label>
                      <input type="checkbox" id="enableVideoChunking" checked />
                      <span>Create video chunks based on transcription segments</span>
                    </label>
                    <small>Splits videos into smaller files matching transcript segments (requires more storage)</small>
                  </div>

                  <div class="gpu-status" id="gpuStatus">
                    <span class="status-icon">🖥️</span>
                    <span class="status-text">GPU Status: Checking...</span>
                  </div>
                </div>
              </div>

              <div class="save-preset">
                <button id="savePresetBtn" class="btn">Save as Preset</button>
                <select id="loadPreset">
                  <option value="">Load Preset...</option>
                  <option value="minimal">Minimal (Titles Only)</option>
                  <option value="metadata">Metadata Only</option>
                  <option value="full">Full Collection</option>
                  <option value="research">Research Grade</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Search Results -->
          <div id="searchResults" class="search-results" style="display: none;">
            <h3>Search Results</h3>
            <div class="results-header">
              <div class="results-actions">
                <button id="selectAllBtn" class="btn btn-sm">Select All</button>
                <button id="deselectAllBtn" class="btn btn-sm">Deselect All</button>
                <select id="bulkAction" class="bulk-select">
                  <option value="">Bulk Actions...</option>
                  <option value="select-hd">Select HD Only</option>
                  <option value="select-popular">Select Popular (>100k views)</option>
                  <option value="select-recent">Select Recent (< 1 month)</option>
                </select>
              </div>
              <div class="results-summary">
                <span id="resultsCount">0 videos found</span>
                <button id="startCollectionBtn" class="btn btn-primary" disabled>
                  Start Collection (<span id="selectedCount">0</span> selected)
                </button>
              </div>
            </div>
            <div id="resultsList" class="results-list"></div>
          </div>

          <!-- Collection Progress -->
          <div id="collectionProgress" class="collection-progress" style="display: none;">
            <h3>Collection Progress</h3>
            <div class="progress-stats">
              <div class="stat">
                <span class="label">Status:</span>
                <span id="collectionStatus" class="value">Initializing...</span>
              </div>
              <div class="stat">
                <span class="label">Videos:</span>
                <span id="progressText" class="value">0 / 0</span>
              </div>
              <div class="stat">
                <span class="label">Comments:</span>
                <span id="commentsProgress" class="value">0</span>
              </div>
              <div class="stat">
                <span class="label">API Units:</span>
                <span id="apiUnitsUsed" class="value">0</span>
              </div>
              <div class="stat">
                <span class="label">Time Elapsed:</span>
                <span id="timeElapsed" class="value">00:00</span>
              </div>
              <div class="stat">
                <span class="label">Est. Remaining:</span>
                <span id="timeRemaining" class="value">--:--</span>
              </div>
            </div>
            <div class="progress-bar">
              <div id="progressFill" class="progress-fill" style="width: 0%"></div>
            </div>
            <div class="progress-actions">
              <button id="pauseBtn" class="btn">Pause</button>
              <button id="cancelBtn" class="btn btn-danger">Cancel</button>
              <button id="openOutputBtn" class="btn" title="Open output folder">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 5px;">
                  <path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"></path>
                  <path d="M12 11v6"></path>
                  <path d="M9 14l3-3 3 3"></path>
                </svg>
                Open Folder
              </button>
            </div>
            <div id="collectionLog" class="collection-log"></div>
          </div>
        </div>

        <!-- PDF Documents View -->
        <div id="pdfView" class="view">
          <div class="view-header">
            <h2>📄 PDF Documents</h2>
            <p style="margin: 8px 0 0; color: var(--text-secondary); font-size: 14px;">
              Upload PDF documents to create collections for rating and comparison alongside YouTube content
            </p>
          </div>

          <div class="pdf-upload-section" style="margin-top: 24px;">
            <div class="option-group">
              <h4>Collection</h4>
              <div class="form-group">
                <label style="display: flex; align-items: center; margin-bottom: 8px;">
                  <input type="radio" name="pdfCollectionMode" id="pdfNewCollection" value="new" checked style="margin-right: 8px;">
                  Create new collection
                </label>
                <label style="display: flex; align-items: center;">
                  <input type="radio" name="pdfCollectionMode" id="pdfExistingCollection" value="existing" style="margin-right: 8px;">
                  Add to existing collection
                </label>
              </div>

              <div id="pdfNewCollectionSection" class="form-group">
                <label for="pdfCollectionName">Collection Name</label>
                <input type="text" id="pdfCollectionName" class="form-control" placeholder="e.g., Research Papers 2024" />
                <small>Name for your new PDF collection</small>
              </div>

              <div id="pdfExistingCollectionSection" class="form-group" style="display: none;">
                <label for="pdfCollectionSelect">Select Collection</label>
                <select id="pdfCollectionSelect" class="form-control">
                  <option value="">Loading collections...</option>
                </select>
                <small>Add PDF to an existing collection</small>
              </div>
            </div>

            <div class="option-group">
              <h4>Upload PDF File</h4>
              <div class="form-group">
                <label for="pdfFileInput">PDF Document</label>
                <div class="file-input-wrapper">
                  <input type="file" id="pdfFileInput" accept=".pdf" style="display: none;" />
                  <button id="pdfFileBrowseBtn" class="btn btn-secondary" style="width: 100%;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                      <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"></path>
                    </svg>
                    Choose PDF File
                  </button>
                </div>
                <div id="pdfFileName" style="margin-top: 8px; font-size: 14px; color: var(--text-secondary);"></div>
              </div>

              <div class="form-group">
                <label for="pdfTitle">Document Title (Optional)</label>
                <input type="text" id="pdfTitle" class="form-control" placeholder="Will use filename if not provided" />
                <small>Custom title for this PDF document</small>
              </div>
            </div>

            <div class="option-group">
              <h4>Chunking Strategy</h4>
              <div class="form-group">
                <label for="pdfChunkingStrategy">How to Split PDF</label>
                <select id="pdfChunkingStrategy" class="form-control">
                  <option value="page">Page-based (one excerpt per page)</option>
                  <option value="sentence" selected>Sentence-based (recommended for visual highlighting)</option>
                  <option value="semantic">Semantic (paragraph/section-based)</option>
                  <option value="fixed">Fixed-size (by word count)</option>
                </select>
                <small>Sentence-based provides the best granularity for visual PDF viewer with highlighting</small>
              </div>

              <div id="pdfFixedSizeOptions" class="sub-options" style="display: none;">
                <div class="form-group">
                  <label for="pdfChunkSize">Words per Excerpt</label>
                  <input type="number" id="pdfChunkSize" class="form-control" value="500" min="100" max="2000" step="50" />
                  <small>Number of words in each excerpt (100-2000)</small>
                </div>
              </div>
            </div>

            <div class="form-group" style="margin-top: 24px;">
              <button id="uploadPDFBtn" class="btn btn-primary" style="width: 100%;" disabled>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                  <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"></path>
                </svg>
                Upload and Process PDF
              </button>
            </div>

            <div id="pdfUploadProgress" style="display: none; margin-top: 16px;">
              <div class="progress-info">
                <span id="pdfUploadStatus">Processing...</span>
                <span id="pdfUploadPercentage">0%</span>
              </div>
              <div class="progress-bar">
                <div id="pdfUploadProgressBar" class="progress-fill" style="width: 0%;"></div>
              </div>
            </div>

            <div id="pdfUploadLog" class="collection-log" style="margin-top: 16px; max-height: 300px; overflow-y: auto;"></div>

            <div class="option-group" style="margin-top: 32px;">
              <h4>Uploaded PDFs</h4>
              <div id="pdfDocumentsList" class="pdf-list">
                <div class="empty-state">
                  <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                  </svg>
                  <h3>No PDFs Uploaded</h3>
                  <p>Select a collection and upload your first PDF document to get started</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Collections View -->
        <div id="collectionsView" class="view active">
          <!-- Collections Hub Container -->
          <div id="collections-hub-container"></div>

          <!-- Tab Navigation -->
          <div class="tabs">
            <button class="tab-btn active" data-tab="saved">Saved Collections</button>
            <button class="tab-btn" data-tab="merged">Merged Collections</button>
          </div>

          <!-- Saved Collections Tab -->
          <div id="savedTab" class="tab-content active">
            <!-- Folder Browser Component -->
            <div class="folder-browser-container">
              <div class="folder-browser-header">
                <h3>Collections</h3>
                <div style="display: flex; gap: 0.5rem;">
                  <button id="new-collection-btn" class="btn btn-success" onclick="window.folderBrowser.showNewCollectionModal()">
                    <span>➕</span> New Collection
                  </button>
                  <button id="create-folder-btn" class="btn btn-primary">
                    <span>📁</span> New Folder
                  </button>
                  <button id="import-collection-btn" class="btn btn-secondary">
                    <span>📥</span> Import
                  </button>
                  <button id="export-database-btn" class="btn btn-secondary">
                    <span>💾</span> Backup DB
                  </button>
                </div>
              </div>

              <div id="folder-tree" class="folder-tree">
                <!-- Tree will be rendered here by folder-browser.js -->
                <div class="folder-tree-loading">
                  Loading collections...
                </div>
              </div>
            </div>

            <!-- Context menu (hidden by default) -->
            <div id="folder-context-menu" class="context-menu" style="display: none;">
              <div class="context-menu-item" data-action="rename">Rename</div>
              <div class="context-menu-item" data-action="delete">Delete</div>
              <div class="context-menu-item" data-action="archive">Archive</div>
              <div class="context-menu-item" data-action="color">Change Color</div>
              <div class="context-menu-item" data-action="star">Star</div>
              <div class="context-menu-item" data-action="move">Move</div>
              <div class="context-menu-item" data-action="rate">🤖 Rate Collection</div>
              <div class="context-menu-item" data-action="bws">🔀 BWS Experiment</div>
              <div class="context-menu-item" data-action="export">📤 Export</div>
            </div>
          </div>

          <!-- Merged Collections Tab -->
          <div id="mergedTab" class="tab-content">
            <div class="view-header">
              <h3 style="margin: 0;">Merged Collections</h3>
              <button id="createMergeBtn" class="btn btn-primary">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Create Merge
              </button>
            </div>

            <div id="mergeList" class="merge-list">
              <div class="empty-state">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M4 7h16M4 12h16M4 17h16"></path>
                  <path d="M12 3v18" opacity="0.3"></path>
                </svg>
                <h3>No Merged Collections</h3>
                <p>Combine multiple collections into one dataset for analysis or rating</p>
                <button class="btn btn-primary" onclick="document.getElementById('createMergeBtn').click()">Create Your First Merge</button>
              </div>
            </div>
          </div>
        </div>


        <!-- Export View -->
        <div id="exportView" class="view">
          <h2>Export Data</h2>
          <div class="export-options">
            <div class="export-format">
              <h3>Export to CARDS Format</h3>
              <p>Export your collected data in CARDS 2.0 format for use with Variable Resolution BWS rating system.</p>
              <button id="exportCardsBtn" class="btn btn-primary">Export to CARDS</button>
            </div>
            <div class="export-format">
              <h3>Export to CSV</h3>
              <p>Export data as CSV files for analysis in Excel, R, or Python.</p>
              <button id="exportCsvBtn" class="btn">Export to CSV</button>
            </div>
            <div class="export-format">
              <h3>Export to Supabase</h3>
              <p>Upload directly to your Supabase instance for online rating.</p>
              <button id="exportSupabaseBtn" class="btn">Export to Supabase</button>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal" style="display: none;">
      <div class="modal-content">
        <h2>Settings</h2>
        <div class="settings-form">
          <h3>API Configuration</h3>
          <div class="form-group">
            <label for="youtubeApiKey">YouTube API Key</label>
            <input type="password" id="youtubeApiKey" placeholder="Enter your YouTube Data API v3 key" />
            <small>Get your API key from <a href="https://console.cloud.google.com/apis/library/youtube.googleapis.com" target="_blank">Google Cloud Console</a></small>
          </div>

          <div class="form-group">
            <label>API Key Status</label>
            <div class="api-status">
              <span id="apiKeyStatus" class="status-indicator">Not Set</span>
              <button id="testApiBtn" class="btn btn-sm">Test API Key</button>
            </div>
          </div>

          <div class="form-group">
            <label for="geminiApiKey">Gemini API Key (for AI Analysis)</label>
            <input type="password" id="geminiApiKey" placeholder="Enter your Gemini API key" />
            <small>Get your API key from <a href="https://aistudio.google.com/apikey" target="_blank">Google AI Studio</a></small>
          </div>

          <div class="form-group">
            <label>Gemini API Status</label>
            <div class="api-status">
              <span id="geminiApiStatus" class="status-indicator">Not Set</span>
              <button id="testGeminiBtn" class="btn btn-sm">Test Gemini</button>
            </div>
          </div>
          
          <h3>Storage Settings</h3>
          <div class="form-group">
            <label for="outputDir">Output Directory</label>
            <div class="input-group">
              <input type="text" id="outputDir" readonly placeholder="Select output directory" />
              <button id="selectDirBtn" class="btn">Browse</button>
            </div>
          </div>

          <div class="form-group">
            <label for="storageLimit">Storage Limit (GB)</label>
            <input type="number" id="storageLimit" value="50" min="1" max="1000" />
            <small>Stop collection when this much disk space is used</small>
          </div>

          <h3>Supabase Integration (Optional)</h3>
          <div class="form-group">
            <label for="supabaseUrl">Supabase URL</label>
            <input type="text" id="supabaseUrl" placeholder="https://your-project.supabase.co" />
          </div>

          <div class="form-group">
            <label for="supabaseKey">Supabase Anon Key</label>
            <input type="password" id="supabaseKey" placeholder="Your Supabase anonymous key" />
          </div>

          <h3>Advanced Settings</h3>
          <div class="form-group">
            <label for="concurrency">Concurrent Downloads</label>
            <input type="number" id="concurrency" value="3" min="1" max="10" />
            <small>Number of simultaneous video downloads</small>
          </div>

          <div class="form-group checkbox-group">
            <label>
              <input type="checkbox" id="autoRetry" checked />
              <span>Auto-retry failed downloads</span>
            </label>
          </div>

          <div class="form-group checkbox-group">
            <label>
              <input type="checkbox" id="enableLogging" checked />
              <span>Enable detailed logging</span>
            </label>
          </div>
        </div>
        <div class="modal-actions">
          <button id="saveSettingsBtn" class="btn btn-primary">Save Settings</button>
          <button id="closeSettingsBtn" class="btn">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Merge Modal -->
  <div id="createMergeModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h2>Create Merged Collection</h2>
        <button class="modal-close" onclick="document.getElementById('createMergeModal').style.display='none'">&times;</button>
      </div>

      <div class="modal-body">
        <div class="form-group">
          <label for="mergeName">Merge Name *</label>
          <input type="text" id="mergeName" placeholder="e.g., All Dog Studies Combined" required />
          <small>A descriptive name for this merged collection</small>
        </div>

        <div class="form-group">
          <label for="mergeDescription">Description (Optional)</label>
          <textarea id="mergeDescription" rows="3" placeholder="Describe the purpose of this merge..."></textarea>
        </div>

        <div class="form-group">
          <label>Select Collections to Merge *</label>
          <div id="mergeCollectionsList" class="collection-checklist">
            <div class="loading-spinner">Loading collections...</div>
          </div>
          <small>Select at least 2 collections to merge</small>
        </div>

        <div id="mergePreview" class="merge-preview" style="display: none;">
          <h4>Merge Preview</h4>
          <div class="preview-stats">
            <div class="stat-item">
              <span class="stat-label">Collections:</span>
              <span class="stat-value" id="previewCollectionCount">0</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Total Videos:</span>
              <span class="stat-value" id="previewVideoCount">~0</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Total Comments:</span>
              <span class="stat-value" id="previewCommentCount">~0</span>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button id="confirmCreateMergeBtn" class="btn btn-primary" disabled>Create Merge</button>
        <button class="btn" onclick="document.getElementById('createMergeModal').style.display='none'">Cancel</button>
      </div>
    </div>
  </div>

  <!-- View Merge Modal -->
  <div id="viewMergeModal" class="modal" style="display: none;">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h2 id="viewMergeName">Merged Collection</h2>
        <button class="modal-close" onclick="document.getElementById('viewMergeModal').style.display='none'">&times;</button>
      </div>

      <div class="modal-body">
        <div id="viewMergeContent">
          <!-- Dynamically populated -->
        </div>
      </div>

      <div class="modal-actions">
        <button id="deleteMergeBtn" class="btn btn-danger">Delete Merge</button>
        <button class="btn" onclick="document.getElementById('viewMergeModal').style.display='none'">Close</button>
      </div>
    </div>
  </div>

  <script src="src/components/fixed-tool-checker.js"></script>
  <script src="src/components/tool-installer.js"></script>
  <script src="src/components/collection-viewer.js"></script>
  <script src="src/components/enhanced-viewer.js"></script>
  <script src="src/components/gallery-viewer.js"></script>
  <script src="src/components/modern-single-page.js"></script>
  <script src="src/components/merge-manager.js"></script>
  <!-- Stubs removed - using real APIs now -->
  <script src="src/components/folder-browser.js"></script>
  <script src="src/components/collections-hub.js"></script>

  <!-- PDF.js Library for visual PDF rendering -->
  <script src="node_modules/pdfjs-dist/build/pdf.js"></script>
  <script>
    // Configure PDF.js worker
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'node_modules/pdfjs-dist/build/pdf.worker.js';
    }
  </script>

  <!-- PDF Components -->
  <script src="src/components/pdf-renderer.js"></script>
  <script src="src/components/pdf-highlighter.js"></script>
  <script src="src/components/pdf-excerpt-viewer.js"></script>

  <!-- PDF Services -->
  <script src="src/services/pdf-page-image-generator.js"></script>

  <script src="src/bws-manager.js"></script>
  <script src="src/renderer-advanced.js"></script>

  <!-- Create New Rating Project Modal (Global) -->
  <div id="create-project-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Create New Rating Project</h3>
        <button class="close-btn" id="close-create-modal">&times;</button>
      </div>
      <div class="modal-body">
        <!-- Parent Project Info (shown when creating child) -->
        <div id="parent-project-info" class="parent-project-notice" style="display:none;">
          <div class="notice-box">
            <strong>Creating Child Project</strong>
            <p>This project will use ratings from: <span id="parent-project-name-display"></span></p>
            <p class="small">Items will be filtered based on the criteria below.</p>
          </div>
        </div>

        <!-- Collection Selection -->
        <div class="form-group">
          <label for="ai-collection-select">Select Collection:</label>
          <select id="ai-collection-select" class="form-control">
            <option value="">Choose a collection...</option>
          </select>
          <input type="hidden" id="parent-project-id" value="">
        </div>

        <!-- Filter Criteria (shown only for child projects) -->
        <div id="filter-criteria-section" style="display:none;">
          <div class="form-group">
            <label>Filter Parent Project Items:</label>
            <div class="filter-controls">
              <div class="filter-row">
                <label for="filter-min-score">Minimum Score:</label>
                <input type="number" id="filter-min-score" class="form-control" value="0.7" min="0" max="1" step="0.1">
                <label for="filter-max-score">Maximum Score:</label>
                <input type="number" id="filter-max-score" class="form-control" value="1.0" min="0" max="1" step="0.1">
              </div>
              <div class="filter-row">
                <label class="checkbox-label">
                  <input type="checkbox" id="filter-video-chunks" checked>
                  <span>Include Video Chunks</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" id="filter-comments" checked>
                  <span>Include Comments</span>
                </label>
              </div>
              <div class="filter-preview">
                <small>Estimated items after filtering: <strong id="filtered-items-count">calculating...</strong></small>
              </div>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="project-name">Project Name:</label>
          <input type="text" id="project-name" class="form-control" placeholder="e.g., Mental Health Stigma Analysis">
        </div>

    <div class="form-group">
      <label for="research-intent">What are you looking for? (Research Intent)</label>
      <textarea id="research-intent" class="form-control" rows="4"
        placeholder="Describe what content is relevant to your research. Be specific about topics, themes, or patterns you want to identify."></textarea>
    </div>

    <div class="form-group">
      <label>Rating Scale:</label>
      <div class="radio-group">
        <label class="radio-label">
          <input type="radio" name="rating-scale" value="binary" checked>
          <span>Relevant / Not Relevant</span>
        </label>
        <label class="radio-label">
          <input type="radio" name="rating-scale" value="ternary">
          <span>High / Medium / Low Relevance</span>
        </label>
        <label class="radio-label">
          <input type="radio" name="rating-scale" value="five_point">
          <span>5-Point Scale (1-5)</span>
        </label>
      </div>
    </div>

    <div class="form-group">
      <label>Content to Rate:</label>
      <div class="checkbox-group">
        <label class="checkbox-label">
          <input type="checkbox" id="rate-chunks" checked>
          <span>Video Chunks <span class="item-count" id="chunks-count">(0 items)</span></span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" id="rate-comments" checked>
          <span>Comments <span class="item-count" id="comments-count">(0 items)</span></span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" id="rate-pdfs" checked>
          <span>PDF Excerpts <span class="item-count" id="pdfs-count">(0 items)</span></span>
        </label>
      </div>
    </div>

    <!-- PDF Visual Context Mode -->
    <div class="form-group" id="pdf-visual-mode-section" style="padding-left: 1.5rem; margin-top: -0.5rem;">
      <label class="checkbox-label">
        <input type="checkbox" id="pdf-visual-mode" checked>
        <span>📸 Include PDF Visual Context</span>
      </label>
      <small style="display: block; margin-left: 1.7rem; color: #6b7280; margin-top: 0.25rem;">
        Send page images with highlighted excerpts to AI (richer context but slower)
      </small>
    </div>

    <details class="advanced-options">
      <summary>⚙️ Rate Limiting & Performance</summary>
      <div class="advanced-content">
        <div class="form-group">
          <label for="concurrent-requests">Concurrent Requests:</label>
          <input type="number" id="concurrent-requests" class="form-control" value="5" min="1" max="20">
          <small>⚠️ How many API calls at once (lower = more stable, 5 recommended)</small>
        </div>

        <div class="form-group">
          <label for="batch-size">Batch Size:</label>
          <input type="number" id="batch-size" class="form-control" value="50" min="10" max="200">
          <small>Items processed before progress update (doesn't affect speed)</small>
        </div>

        <div class="form-group">
          <label for="retry-delay">Retry Delay (seconds):</label>
          <input type="number" id="retry-delay" class="form-control" value="2" min="1" max="10" step="0.5">
          <small>Wait time between retries (with exponential backoff)</small>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="include-confidence" checked>
            <span>Include confidence scores</span>
          </label>
        </div>
      </div>
    </details>

    <div class="cost-estimate">
      Estimated: <span id="items-estimate">0 items</span> × ~$0.00015 = <span id="cost-estimate">$0.00</span>
    </div>

        <div class="button-group">
          <button class="btn btn-primary" id="start-rating-btn">Start Rating</button>
          <button class="btn btn-secondary" id="preview-rating-btn">🔍 Preview First 5</button>
        </div>
      </div>
    </div>
  </div>
  <!-- End Create New Rating Project Modal -->

  <!-- BWS (Best-Worst Scaling) Modals -->
  <!-- Create BWS Experiment Modal -->
  <div id="create-bws-modal" class="modal" style="display: none;">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h3>Create BWS Experiment</h3>
        <button class="close-btn" id="close-bws-modal">&times;</button>
      </div>
      <div class="modal-body">
        <!-- Step 1: Choose Source Type -->
        <div class="form-group">
          <label>What do you want to compare?</label>
          <div class="radio-group" style="display: flex; gap: 20px; margin-bottom: 10px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="radio" name="bws-source-type" value="rating-project" checked>
              <span>Items from a Rating Project</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="radio" name="bws-source-type" value="collection">
              <span>Items from a Collection</span>
            </label>
          </div>
          <small id="bws-source-type-hint">Use rated items filtered by relevance score</small>
        </div>

        <!-- Rating Project Selection -->
        <div id="bws-rating-project-section" class="form-group">
          <label for="bws-rating-project-select">Select Rating Project:</label>
          <select id="bws-rating-project-select" class="form-control">
            <option value="">Choose a rating project...</option>
          </select>
          <small>Select a completed rating project to use as source for BWS comparisons</small>
        </div>

        <!-- Collection Selection -->
        <div id="bws-collection-section" class="form-group" style="display: none;">
          <label for="bws-collection-select">Select Collection:</label>
          <select id="bws-collection-select" class="form-control">
            <option value="">Choose a collection...</option>
          </select>
          <small>Compare items directly from a collection (without needing ratings first)</small>
        </div>

        <!-- Collection Content Type Selection -->
        <div id="bws-collection-content-section" style="display: none;">
          <div class="form-group">
            <label>What to compare:</label>
            <div class="checkbox-group">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 8px;">
                <input type="checkbox" id="bws-include-comments" checked>
                <span>Comments</span>
              </label>
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 8px;">
                <input type="checkbox" id="bws-include-chunks">
                <span>Video Chunks</span>
              </label>
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="bws-include-pdfs">
                <span>PDF Excerpts</span>
              </label>
            </div>
            <small>Select which types of content to include in the comparison</small>
          </div>
        </div>

        <!-- Source Info Display -->
        <div id="bws-source-info" class="notice-box" style="display:none;">
          <div class="info-row">
            <strong>Source:</strong> <span id="bws-selected-source-name"></span>
          </div>
          <div class="info-row">
            <strong>Total Items:</strong> <span id="bws-total-items">0</span>
          </div>
          <div class="info-row">
            <strong>Item Type:</strong> <span id="bws-item-type"></span>
          </div>
        </div>

        <!-- Step 2: Filter Criteria (only for rating projects) -->
        <div id="bws-filter-section" style="display:none;">
          <div class="form-group">
            <label>Filter Items by Score:</label>
            <div class="filter-row">
              <label for="bws-min-score">Minimum Score:</label>
              <input type="number" id="bws-min-score" class="form-control" value="0.7" min="0" max="1" step="0.1">
              <small>Only include items with relevance score ≥ this value</small>
            </div>
            <div class="filter-preview">
              <small>Filtered items: <strong id="bws-filtered-count">calculating...</strong></small>
            </div>
          </div>
        </div>

        <!-- Step 3: Experiment Configuration -->
        <div id="bws-config-section" style="display:none;">
          <div class="form-group">
            <label for="bws-experiment-name">Experiment Name:</label>
            <input type="text" id="bws-experiment-name" class="form-control" placeholder="e.g., Top Quality Comments Ranking">
          </div>

          <div class="form-group">
            <label for="bws-research-intent">Comparison Criteria / Research Intent:</label>
            <textarea id="bws-research-intent" class="form-control" rows="3"
              placeholder="What makes one item better than another? Be specific about the quality dimension you're measuring."></textarea>
            <small>Example: "Which comment provides the most substantive, informative content about the topic?"</small>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="bws-tuple-size">Tuple Size:</label>
              <select id="bws-tuple-size" class="form-control">
                <option value="2">2 items (pairwise)</option>
                <option value="3" selected>3 items</option>
                <option value="4">4 items</option>
                <option value="5">5 items</option>
              </select>
              <small>How many items to show per comparison</small>
            </div>

            <div class="form-group">
              <label for="bws-target-appearances">Target Appearances:</label>
              <input type="number" id="bws-target-appearances" class="form-control" value="4" min="2" max="10">
              <small>Times each item should appear (affects total comparisons)</small>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="bws-design-method">Generation Method:</label>
              <select id="bws-design-method" class="form-control">
                <option value="random">Random (fast, simple)</option>
                <option value="balanced" selected>Balanced (equal coverage)</option>
                <option value="maxdiff">MaxDiff (optimal, future)</option>
              </select>
              <small>How to generate comparison sets</small>
            </div>

            <div class="form-group">
              <label for="bws-rater-type">Rater Type:</label>
              <select id="bws-rater-type" class="form-control">
                <option value="ai" selected>AI + Human (Unified Interface)</option>
              </select>
              <small>AI ratings (bright borders) + Your ratings (light borders) in one interface</small>
            </div>
          </div>

          <div class="form-group">
            <label for="bws-scoring-method">Scoring Method:</label>
            <select id="bws-scoring-method" class="form-control">
              <option value="counting" selected>Counting (simple: #best - #worst)</option>
              <option value="bradley_terry">Bradley-Terry (probabilistic, future)</option>
            </select>
            <small>How to calculate final rankings</small>
          </div>

          <!-- Estimate Display -->
          <div class="cost-estimate">
            <div class="estimate-row">
              <span>Estimated comparisons:</span>
              <strong id="bws-estimate-tuples">0</strong>
            </div>
            <div class="estimate-row">
              <span>Items to rank:</span>
              <strong id="bws-estimate-items">0</strong>
            </div>
            <div class="estimate-row" id="bws-ai-cost-row" style="display:none;">
              <span>Estimated AI cost:</span>
              <strong id="bws-estimate-cost">$0.00</strong>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="button-group">
          <button class="btn btn-secondary" id="bws-cancel-btn">Cancel</button>
          <button class="btn btn-primary" id="bws-create-btn" disabled>Create Experiment</button>
        </div>
      </div>
    </div>
  </div>
  <!-- End Create BWS Modal -->
  <!-- Note: BWS Rating Interface, Video Detail Modal, AI Progress Overlay, and Results View were removed for brevity.
       They are loaded dynamically by the BWS Manager when needed. -->

</body>
</html>