<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https: file:; media-src 'self' file:; connect-src 'self' https:">
  <title>VR Data Collector</title>
  <link rel="stylesheet" href="src/styles/main.css">
  <link rel="stylesheet" href="src/styles/advanced.css">
  <link rel="stylesheet" href="src/styles/status.css">
    <link rel="stylesheet" href="src/styles/tool-installer.css">
    <link rel="stylesheet" href="src/styles/collections.css">
    <link rel="stylesheet" href="src/styles/collection-viewer.css">
    <link rel="stylesheet" href="src/styles/rating-projects.css">
    <link rel="stylesheet" href="src/styles/merged-collections.css">
    <link rel="stylesheet" href="src/styles/folder-browser.css">
    <link rel="stylesheet" href="src/styles/pdf-excerpt-viewer.css">
  </head>
<body>
  <div id="app">
    <!-- Header -->
    <header class="header">
      <h1>Variable Resolution Data Collector</h1>
      <div class="header-actions">
        <button id="openOutputHeaderBtn" class="btn btn-icon" title="Open output folder">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"></path>
          </svg>
        </button>
        <button id="settingsBtn" class="btn btn-icon" title="Settings">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M12 1v6m0 6v6m4.22-10.22l1.42-1.42m-1.42 10.88l1.42 1.42M20 12h-6m-6 0H2m10.22-4.22L10.8 6.36m1.42 10.88l-1.42 1.42"></path>
          </svg>
        </button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Sidebar -->
      <aside class="sidebar">
        <nav class="nav">
          <button class="nav-item active" data-view="youtube">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
            </svg>
            YouTube
          </button>
          <button class="nav-item" data-view="pdf">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            PDF Documents
          </button>
          <button class="nav-item" data-view="collections">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
            </svg>
            Collections
          </button>
          <button class="nav-item" data-view="ai-analysis">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
              <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
              <line x1="12" y1="22.08" x2="12" y2="12"></line>
            </svg>
            AI Analysis
          </button>
          <button class="nav-item" data-view="export">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Export
          </button>
        </nav>
      </aside>

      <!-- Content Area -->
      <section class="content">
        <!-- YouTube View -->
        <div id="youtubeView" class="view active">
          <!-- Tab Navigation -->
          <div class="tabs">
            <button class="tab-btn active" data-tab="basic">Basic Search</button>
            <button class="tab-btn" data-tab="advanced">Advanced Options</button>
            <button class="tab-btn" data-tab="extraction">Data Extraction</button>
          </div>

          <!-- Basic Search Tab -->
          <div id="basicTab" class="tab-content active">
            <div class="search-section">
              <h2>YouTube Data Collection</h2>
              <div class="search-form">
                <div class="form-group">
                  <label for="searchTerm">Search Term</label>
                  <input type="text" id="searchTerm" placeholder="e.g., ADHD, mental health, climate change" />
                  <small>Enter keywords to search for YouTube videos</small>
                </div>
                
                <div class="form-row">
                  <div class="form-group">
                    <label for="maxResults">Max Videos</label>
                    <input type="number" id="maxResults" min="1" max="500" value="50" />
                    <small>Number of videos to search for</small>
                  </div>
                  
                  <div class="form-group">
                    <label for="dateRange">Date Range</label>
                    <select id="dateRange">
                      <option value="all">All Time</option>
                      <option value="today">Today</option>
                      <option value="week">This Week</option>
                      <option value="month" selected>This Month</option>
                      <option value="year">This Year</option>
                      <option value="custom">Custom Range</option>
                    </select>
                  </div>
                </div>

                <div class="form-group">
                  <label for="orderBy">Order By</label>
                  <select id="orderBy">
                    <option value="relevance">Relevance</option>
                    <option value="date">Upload Date</option>
                    <option value="viewCount" selected>View Count</option>
                    <option value="rating">Rating</option>
                    <option value="title">Title (A-Z)</option>
                  </select>
                  <small>How to sort search results</small>
                </div>

                <button id="searchBtn" class="btn btn-primary">
                  Search YouTube
                </button>
              </div>
            </div>
          </div>

          <!-- Advanced Options Tab -->
          <div id="advancedTab" class="tab-content">
            <div class="advanced-section">
              <h2>Advanced Search Options</h2>
              
              <div class="option-group">
                <h3>Video Filters</h3>
                <div class="form-row">
                  <div class="form-group">
                    <label for="videoDuration">Video Duration</label>
                    <select id="videoDuration">
                      <option value="any">Any Duration</option>
                      <option value="short">< 4 minutes</option>
                      <option value="medium">4-20 minutes</option>
                      <option value="long">> 20 minutes</option>
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="videoDefinition">Video Quality</label>
                    <select id="videoDefinition">
                      <option value="any">Any Quality</option>
                      <option value="high">HD Only</option>
                      <option value="standard">Standard</option>
                    </select>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="minViews">Minimum Views</label>
                    <input type="number" id="minViews" placeholder="e.g., 10000" />
                  </div>
                  
                  <div class="form-group">
                    <label for="maxViews">Maximum Views</label>
                    <input type="number" id="maxViews" placeholder="e.g., 1000000" />
                  </div>
                </div>

                <div class="form-group">
                  <label for="videoLanguage">Video Language</label>
                  <select id="videoLanguage">
                    <option value="">Any Language</option>
                    <option value="en" selected>English</option>
                    <option value="es">Spanish</option>
                    <option value="fr">French</option>
                    <option value="de">German</option>
                    <option value="ja">Japanese</option>
                    <option value="ko">Korean</option>
                    <option value="zh">Chinese</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="channelType">Channel Type</label>
                  <select id="channelType">
                    <option value="any">Any Channel</option>
                    <option value="show">TV Shows</option>
                    <option value="movie">Movies</option>
                  </select>
                </div>

                <div class="form-group checkbox-group">
                  <label>
                    <input type="checkbox" id="embeddable" />
                    <span>Embeddable videos only</span>
                  </label>
                  <small>Videos that can be played outside YouTube</small>
                </div>

                <div class="form-group checkbox-group">
                  <label>
                    <input type="checkbox" id="syndicated" checked />
                    <span>Include syndicated videos</span>
                  </label>
                  <small>Videos that can be played outside youtube.com</small>
                </div>
              </div>

              <div class="option-group">
                <h3>API Configuration</h3>
                <div class="form-group">
                  <label for="apiQuotaLimit">API Quota Limit</label>
                  <input type="number" id="apiQuotaLimit" value="1000" min="1" max="10000" />
                  <small>Stop collection when this many API units are used</small>
                </div>

                <div class="form-group">
                  <label for="rateLimitDelay">Rate Limit Delay (ms)</label>
                  <input type="number" id="rateLimitDelay" value="500" min="0" max="5000" />
                  <small>Delay between API requests to avoid rate limits</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Data Extraction Tab -->
          <div id="extractionTab" class="tab-content">
            <div class="extraction-section">
              <h2>Data Extraction Settings</h2>
              
              <div class="option-group">
                <h3>Video Metadata</h3>
                <div class="checkbox-list">
                  <label class="checkbox-item">
                    <input type="checkbox" id="extractTitle" checked />
                    <span>Title</span>
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" id="extractDescription" checked />
                    <span>Full Description</span>
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" id="extractTags" checked />
                    <span>Tags</span>
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" id="extractThumbnails" checked />
                    <span>Thumbnails (all resolutions)</span>
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" id="extractCaptions" />
                    <span>Closed Captions/Subtitles</span>
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" id="extractStatistics" checked />
                    <span>Statistics (views, likes, etc.)</span>
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" id="extractPublishDate" checked />
                    <span>Publish Date & Time</span>
                  </label>
                </div>
              </div>

              <div class="option-group">
                <h3>Channel Information</h3>
                <div class="checkbox-list">
                  <label class="checkbox-item">
                    <input type="checkbox" id="extractChannelTitle" checked />
                    <span>Channel Name</span>
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" id="extractChannelId" checked />
                    <span>Channel ID</span>
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" id="extractChannelStats" />
                    <span>Channel Statistics</span>
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" id="extractChannelDescription" />
                    <span>Channel Description</span>
                  </label>
                </div>
              </div>

              <div class="option-group">
                <h3>Comment Settings</h3>
                <div class="form-group checkbox-group">
                  <label>
                    <input type="checkbox" id="includeComments" checked />
                    <span>Extract Comments</span>
                  </label>
                </div>
                
                <div id="commentOptions" class="sub-options">
                  <div class="form-row">
                    <div class="form-group">
                      <label for="maxComments">Max Comments per Video</label>
                      <input type="number" id="maxComments" min="1" max="10000" value="100" />
                    </div>
                    
                    <div class="form-group">
                      <label for="commentSort">Comment Sort Order</label>
                      <select id="commentSort">
                        <option value="relevance">Relevance</option>
                        <option value="time">Newest First</option>
                      </select>
                    </div>
                  </div>

                  <div class="form-group">
                    <label for="minCommentLikes">Min Comment Likes</label>
                    <input type="number" id="minCommentLikes" placeholder="0" value="0" />
                    <small>Only collect comments with at least this many likes</small>
                  </div>

                  <div class="checkbox-list">
                    <label class="checkbox-item">
                      <input type="checkbox" id="includeReplies" />
                      <span>Include Reply Threads</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" id="commentAuthorChannelId" checked />
                      <span>Comment Author Channel ID</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" id="commentTimestamps" checked />
                      <span>Comment Timestamps</span>
                    </label>
                  </div>
                </div>
              </div>

              <div class="option-group">
                <h3>Video File Download</h3>
                <div class="form-group checkbox-group">
                  <label>
                    <input type="checkbox" id="downloadVideo" />
                    <span>Download Video Files</span>
                  </label>
                </div>
                
                <div id="downloadOptions" class="sub-options" style="display: none;">
                  <div class="form-row">
                    <div class="form-group">
                      <label for="videoQuality">Video Quality</label>
                      <select id="videoQuality">
                        <option value="lowest">Lowest Quality (fast)</option>
                        <option value="360p">360p</option>
                        <option value="480p" selected>480p</option>
                        <option value="720p">720p HD</option>
                        <option value="1080p">1080p Full HD</option>
                        <option value="highest">Highest Available</option>
                      </select>
                    </div>
                    
                    <div class="form-group">
                      <label for="videoFormat">Video Format</label>
                      <select id="videoFormat">
                        <option value="mp4" selected>MP4</option>
                        <option value="webm">WebM</option>
                        <option value="any">Best Available</option>
                      </select>
                    </div>
                  </div>

                  <div class="form-group">
                    <label for="maxFileSize">Max File Size (MB)</label>
                    <input type="number" id="maxFileSize" value="500" min="10" max="5000" />
                    <small>Skip videos larger than this size</small>
                  </div>

                  <div class="checkbox-list">
                    <label class="checkbox-item">
                      <input type="checkbox" id="extractAudioOnly" />
                      <span>Extract Audio Only</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" id="downloadThumbnail" checked />
                      <span>Download Thumbnail Image</span>
                    </label>
                  </div>
                </div>
              </div>

              <div class="option-group">
                <h3>Processing Options</h3>
                <div class="form-group">
                  <label for="textProcessing">Text Processing</label>
                  <select id="textProcessing">
                    <option value="none">No Processing</option>
                    <option value="clean">Clean Text (remove emojis, links)</option>
                    <option value="sentiment">Include Sentiment Analysis</option>
                  </select>
                </div>

                <div class="form-group checkbox-group">
                  <label>
                    <input type="checkbox" id="skipDuplicates" checked />
                    <span>Skip duplicate videos</span>
                  </label>
                  <small>Based on video ID</small>
                </div>

                <div class="form-group checkbox-group">
                  <label>
                    <input type="checkbox" id="continueOnError" checked />
                    <span>Continue on errors</span>
                  </label>
                  <small>Don't stop collection if one video fails</small>
                </div>
              </div>

              <div class="option-group">
                <h3>Transcription Settings (Optional)</h3>
                <div class="form-group checkbox-group">
                  <label>
                    <input type="checkbox" id="enableTranscription" />
                    <span>Enable Whisper Transcription</span>
                  </label>
                  <small class="transcription-status" id="transcriptionStatus">Checking availability...</small>
                </div>
                
                <div id="transcriptionOptions" class="sub-options" style="display: none;">
                  <div class="form-row">
                    <div class="form-group">
                      <label for="whisperModel">Whisper Model</label>
                      <select id="whisperModel">
                        <option value="tiny">Tiny (39M, fastest)</option>
                        <option value="base" selected>Base (74M, balanced)</option>
                        <option value="small">Small (244M, better)</option>
                        <option value="medium">Medium (769M, good)</option>
                        <option value="large">Large (1550M, best)</option>
                      </select>
                    </div>
                    
                    <div class="form-group">
                      <label for="whisperDevice">Processing Device</label>
                      <select id="whisperDevice">
                        <option value="auto" selected>Auto-detect</option>
                        <option value="cuda">NVIDIA GPU (CUDA)</option>
                        <option value="mps">Apple Silicon (Metal)</option>
                        <option value="cpu">CPU Only</option>
                      </select>
                    </div>
                  </div>

                  <div class="form-group">
                    <label for="whisperLanguage">Language</label>
                    <select id="whisperLanguage">
                      <option value="auto">Auto-detect</option>
                      <option value="en" selected>English</option>
                      <option value="es">Spanish</option>
                      <option value="fr">French</option>
                      <option value="de">German</option>
                      <option value="ja">Japanese</option>
                      <option value="ko">Korean</option>
                      <option value="zh">Chinese</option>
                    </select>
                  </div>

                  <div class="form-group checkbox-group">
                    <label>
                      <input type="checkbox" id="whisperTimestamps" checked />
                      <span>Include word-level timestamps</span>
                    </label>
                  </div>
                  
                  <div class="form-group checkbox-group">
                    <label>
                      <input type="checkbox" id="enableVideoChunking" checked />
                      <span>Create video chunks based on transcription segments</span>
                    </label>
                    <small>Splits videos into smaller files matching transcript segments (requires more storage)</small>
                  </div>

                  <div class="gpu-status" id="gpuStatus">
                    <span class="status-icon">🖥️</span>
                    <span class="status-text">GPU Status: Checking...</span>
                  </div>
                </div>
              </div>

              <div class="save-preset">
                <button id="savePresetBtn" class="btn">Save as Preset</button>
                <select id="loadPreset">
                  <option value="">Load Preset...</option>
                  <option value="minimal">Minimal (Titles Only)</option>
                  <option value="metadata">Metadata Only</option>
                  <option value="full">Full Collection</option>
                  <option value="research">Research Grade</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Search Results -->
          <div id="searchResults" class="search-results" style="display: none;">
            <h3>Search Results</h3>
            <div class="results-header">
              <div class="results-actions">
                <button id="selectAllBtn" class="btn btn-sm">Select All</button>
                <button id="deselectAllBtn" class="btn btn-sm">Deselect All</button>
                <select id="bulkAction" class="bulk-select">
                  <option value="">Bulk Actions...</option>
                  <option value="select-hd">Select HD Only</option>
                  <option value="select-popular">Select Popular (>100k views)</option>
                  <option value="select-recent">Select Recent (< 1 month)</option>
                </select>
              </div>
              <div class="results-summary">
                <span id="resultsCount">0 videos found</span>
                <button id="startCollectionBtn" class="btn btn-primary" disabled>
                  Start Collection (<span id="selectedCount">0</span> selected)
                </button>
              </div>
            </div>
            <div id="resultsList" class="results-list"></div>
          </div>

          <!-- Collection Progress -->
          <div id="collectionProgress" class="collection-progress" style="display: none;">
            <h3>Collection Progress</h3>
            <div class="progress-stats">
              <div class="stat">
                <span class="label">Status:</span>
                <span id="collectionStatus" class="value">Initializing...</span>
              </div>
              <div class="stat">
                <span class="label">Videos:</span>
                <span id="progressText" class="value">0 / 0</span>
              </div>
              <div class="stat">
                <span class="label">Comments:</span>
                <span id="commentsProgress" class="value">0</span>
              </div>
              <div class="stat">
                <span class="label">API Units:</span>
                <span id="apiUnitsUsed" class="value">0</span>
              </div>
              <div class="stat">
                <span class="label">Time Elapsed:</span>
                <span id="timeElapsed" class="value">00:00</span>
              </div>
              <div class="stat">
                <span class="label">Est. Remaining:</span>
                <span id="timeRemaining" class="value">--:--</span>
              </div>
            </div>
            <div class="progress-bar">
              <div id="progressFill" class="progress-fill" style="width: 0%"></div>
            </div>
            <div class="progress-actions">
              <button id="pauseBtn" class="btn">Pause</button>
              <button id="cancelBtn" class="btn btn-danger">Cancel</button>
              <button id="openOutputBtn" class="btn" title="Open output folder">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 5px;">
                  <path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"></path>
                  <path d="M12 11v6"></path>
                  <path d="M9 14l3-3 3 3"></path>
                </svg>
                Open Folder
              </button>
            </div>
            <div id="collectionLog" class="collection-log"></div>
          </div>
        </div>

        <!-- PDF Documents View -->
        <div id="pdfView" class="view">
          <div class="view-header">
            <h2>📄 PDF Documents</h2>
            <p style="margin: 8px 0 0; color: var(--text-secondary); font-size: 14px;">
              Upload PDF documents to create collections for rating and comparison alongside YouTube content
            </p>
          </div>

          <div class="pdf-upload-section" style="margin-top: 24px;">
            <div class="option-group">
              <h4>Collection</h4>
              <div class="form-group">
                <label style="display: flex; align-items: center; margin-bottom: 8px;">
                  <input type="radio" name="pdfCollectionMode" id="pdfNewCollection" value="new" checked style="margin-right: 8px;">
                  Create new collection
                </label>
                <label style="display: flex; align-items: center;">
                  <input type="radio" name="pdfCollectionMode" id="pdfExistingCollection" value="existing" style="margin-right: 8px;">
                  Add to existing collection
                </label>
              </div>

              <div id="pdfNewCollectionSection" class="form-group">
                <label for="pdfCollectionName">Collection Name</label>
                <input type="text" id="pdfCollectionName" class="form-control" placeholder="e.g., Research Papers 2024" />
                <small>Name for your new PDF collection</small>
              </div>

              <div id="pdfExistingCollectionSection" class="form-group" style="display: none;">
                <label for="pdfCollectionSelect">Select Collection</label>
                <select id="pdfCollectionSelect" class="form-control">
                  <option value="">Loading collections...</option>
                </select>
                <small>Add PDF to an existing collection</small>
              </div>
            </div>

            <div class="option-group">
              <h4>Upload PDF File</h4>
              <div class="form-group">
                <label for="pdfFileInput">PDF Document</label>
                <div class="file-input-wrapper">
                  <input type="file" id="pdfFileInput" accept=".pdf" style="display: none;" />
                  <button id="pdfFileBrowseBtn" class="btn btn-secondary" style="width: 100%;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                      <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"></path>
                    </svg>
                    Choose PDF File
                  </button>
                </div>
                <div id="pdfFileName" style="margin-top: 8px; font-size: 14px; color: var(--text-secondary);"></div>
              </div>

              <div class="form-group">
                <label for="pdfTitle">Document Title (Optional)</label>
                <input type="text" id="pdfTitle" class="form-control" placeholder="Will use filename if not provided" />
                <small>Custom title for this PDF document</small>
              </div>
            </div>

            <div class="option-group">
              <h4>Chunking Strategy</h4>
              <div class="form-group">
                <label for="pdfChunkingStrategy">How to Split PDF</label>
                <select id="pdfChunkingStrategy" class="form-control">
                  <option value="page" selected>Page-based (one excerpt per page)</option>
                  <option value="semantic">Semantic (paragraph/section-based)</option>
                  <option value="fixed">Fixed-size (by word count)</option>
                </select>
                <small>Choose how to divide the PDF into excerpts for rating</small>
              </div>

              <div id="pdfFixedSizeOptions" class="sub-options" style="display: none;">
                <div class="form-group">
                  <label for="pdfChunkSize">Words per Excerpt</label>
                  <input type="number" id="pdfChunkSize" class="form-control" value="500" min="100" max="2000" step="50" />
                  <small>Number of words in each excerpt (100-2000)</small>
                </div>
              </div>
            </div>

            <div class="form-group" style="margin-top: 24px;">
              <button id="uploadPDFBtn" class="btn btn-primary" style="width: 100%;" disabled>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                  <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"></path>
                </svg>
                Upload and Process PDF
              </button>
            </div>

            <div id="pdfUploadProgress" style="display: none; margin-top: 16px;">
              <div class="progress-info">
                <span id="pdfUploadStatus">Processing...</span>
                <span id="pdfUploadPercentage">0%</span>
              </div>
              <div class="progress-bar">
                <div id="pdfUploadProgressBar" class="progress-fill" style="width: 0%;"></div>
              </div>
            </div>

            <div id="pdfUploadLog" class="collection-log" style="margin-top: 16px; max-height: 300px; overflow-y: auto;"></div>

            <div class="option-group" style="margin-top: 32px;">
              <h4>Uploaded PDFs</h4>
              <div id="pdfDocumentsList" class="pdf-list">
                <div class="empty-state">
                  <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                  </svg>
                  <h3>No PDFs Uploaded</h3>
                  <p>Select a collection and upload your first PDF document to get started</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Collections View -->
        <div id="collectionsView" class="view">
          <!-- Tab Navigation -->
          <div class="tabs">
            <button class="tab-btn active" data-tab="saved">Saved Collections</button>
            <button class="tab-btn" data-tab="merged">Merged Collections</button>
          </div>

          <!-- Saved Collections Tab -->
          <div id="savedTab" class="tab-content active">
            <!-- Folder Browser Component -->
            <div class="folder-browser-container">
              <div class="folder-browser-header">
                <h3>Collections</h3>
                <div style="display: flex; gap: 0.5rem;">
                  <button id="new-collection-btn" class="btn btn-success" onclick="window.folderBrowser.showNewCollectionModal()">
                    <span>➕</span> New Collection
                  </button>
                  <button id="create-folder-btn" class="btn btn-primary">
                    <span>📁</span> New Folder
                  </button>
                  <button id="import-collection-btn" class="btn btn-secondary">
                    <span>📥</span> Import
                  </button>
                  <button id="export-database-btn" class="btn btn-secondary">
                    <span>💾</span> Backup DB
                  </button>
                </div>
              </div>

              <div id="folder-tree" class="folder-tree">
                <!-- Tree will be rendered here by folder-browser.js -->
                <div class="folder-tree-loading">
                  Loading collections...
                </div>
              </div>
            </div>

            <!-- Context menu (hidden by default) -->
            <div id="folder-context-menu" class="context-menu" style="display: none;">
              <div class="context-menu-item" data-action="rename">Rename</div>
              <div class="context-menu-item" data-action="delete">Delete</div>
              <div class="context-menu-item" data-action="archive">Archive</div>
              <div class="context-menu-item" data-action="color">Change Color</div>
              <div class="context-menu-item" data-action="star">Star</div>
              <div class="context-menu-item" data-action="move">Move</div>
              <div class="context-menu-item" data-action="export">📤 Export</div>
            </div>
          </div>

          <!-- Merged Collections Tab -->
          <div id="mergedTab" class="tab-content">
            <div class="view-header">
              <h3 style="margin: 0;">Merged Collections</h3>
              <button id="createMergeBtn" class="btn btn-primary">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Create Merge
              </button>
            </div>

            <div id="mergeList" class="merge-list">
              <div class="empty-state">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M4 7h16M4 12h16M4 17h16"></path>
                  <path d="M12 3v18" opacity="0.3"></path>
                </svg>
                <h3>No Merged Collections</h3>
                <p>Combine multiple collections into one dataset for analysis or rating</p>
                <button class="btn btn-primary" onclick="document.getElementById('createMergeBtn').click()">Create Your First Merge</button>
              </div>
            </div>
          </div>
        </div>

        <!-- AI Analysis View -->
        <div id="ai-analysisView" class="view">
          <!-- Sub-Tab Navigation -->
          <div class="tabs">
            <button class="tab-btn active" data-tab="ratings">📊 Ratings</button>
            <button class="tab-btn" data-tab="bws">🔀 BWS</button>
            <button class="tab-btn" data-tab="dashboard">📈 Dashboard</button>
          </div>

          <!-- Ratings Tab (existing content) -->
          <div id="ratingsTab" class="tab-content active">
            <div class="rating-projects-container">
            <!-- Header with Stats -->
            <div class="view-header">
              <h2>🤖 Rating Projects</h2>
              <div class="header-actions">
                <button class="btn btn-primary" id="create-project-btn">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                  Create New Project
                </button>
              </div>
            </div>
            
            <!-- Stats Summary -->
            <div class="stats-bar">
              <div class="stat-item">
                <span class="stat-value" id="totalProjects">0</span>
                <span class="stat-label">projects</span>
              </div>
              <div class="stat-item">
                <span class="stat-value" id="totalRated">0</span>
                <span class="stat-label">items rated</span>
              </div>
              <div class="stat-item">
                <span class="stat-value" id="avgSuccessRate">0%</span>
                <span class="stat-label">avg success rate</span>
              </div>
            </div>
            
            <!-- Search/Filter Bar -->
            <div class="filter-bar">
              <input type="text" id="project-search" class="search-input" placeholder="Search projects...">
              <select id="project-filter-status" class="filter-select">
                <option value="">All Statuses</option>
                <option value="completed">Completed</option>
                <option value="partial">Partial</option>
                <option value="in_progress">In Progress</option>
              </select>
            </div>
            
            <!-- Projects Gallery -->
            <div id="rating-projects-gallery" class="projects-gallery">
              <div class="empty-state">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                  <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                  <line x1="12" y1="22.08" x2="12" y2="12"></line>
                </svg>
                <p>No rating projects yet</p>
                <button class="btn btn-primary" onclick="document.getElementById('create-project-btn').click()">
                  Create Your First Project
                </button>
              </div>
            </div>
            
            <!-- Create New Rating Project Modal -->
            <div id="create-project-modal" class="modal" style="display: none;">
              <div class="modal-content">
                <div class="modal-header">
                  <h3>Create New Rating Project</h3>
                  <button class="close-btn" id="close-create-modal">&times;</button>
                </div>
                <div class="modal-body">
                  <!-- Parent Project Info (shown when creating child) -->
                  <div id="parent-project-info" class="parent-project-notice" style="display:none;">
                    <div class="notice-box">
                      <strong>Creating Child Project</strong>
                      <p>This project will use ratings from: <span id="parent-project-name-display"></span></p>
                      <p class="small">Items will be filtered based on the criteria below.</p>
                    </div>
                  </div>

                  <!-- Collection Selection -->
                  <div class="form-group">
                    <label for="ai-collection-select">Select Collection:</label>
                    <select id="ai-collection-select" class="form-control">
                      <option value="">Choose a collection...</option>
                    </select>
                    <input type="hidden" id="parent-project-id" value="">
                  </div>

                  <!-- Filter Criteria (shown only for child projects) -->
                  <div id="filter-criteria-section" style="display:none;">
                    <div class="form-group">
                      <label>Filter Parent Project Items:</label>
                      <div class="filter-controls">
                        <div class="filter-row">
                          <label for="filter-min-score">Minimum Score:</label>
                          <input type="number" id="filter-min-score" class="form-control" value="0.7" min="0" max="1" step="0.1">
                          <label for="filter-max-score">Maximum Score:</label>
                          <input type="number" id="filter-max-score" class="form-control" value="1.0" min="0" max="1" step="0.1">
                        </div>
                        <div class="filter-row">
                          <label class="checkbox-label">
                            <input type="checkbox" id="filter-video-chunks" checked>
                            <span>Include Video Chunks</span>
                          </label>
                          <label class="checkbox-label">
                            <input type="checkbox" id="filter-comments" checked>
                            <span>Include Comments</span>
                          </label>
                        </div>
                        <div class="filter-preview">
                          <small>Estimated items after filtering: <strong id="filtered-items-count">calculating...</strong></small>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="form-group">
                    <label for="project-name">Project Name:</label>
                    <input type="text" id="project-name" class="form-control" placeholder="e.g., Mental Health Stigma Analysis">
                  </div>
              
              <div class="form-group">
                <label for="research-intent">What are you looking for? (Research Intent)</label>
                <textarea id="research-intent" class="form-control" rows="4" 
                  placeholder="Describe what content is relevant to your research. Be specific about topics, themes, or patterns you want to identify."></textarea>
              </div>
              
              <div class="form-group">
                <label>Rating Scale:</label>
                <div class="radio-group">
                  <label class="radio-label">
                    <input type="radio" name="rating-scale" value="binary" checked>
                    <span>Relevant / Not Relevant</span>
                  </label>
                  <label class="radio-label">
                    <input type="radio" name="rating-scale" value="ternary">
                    <span>High / Medium / Low Relevance</span>
                  </label>
                  <label class="radio-label">
                    <input type="radio" name="rating-scale" value="five_point">
                    <span>5-Point Scale (1-5)</span>
                  </label>
                </div>
              </div>
              
              <div class="form-group">
                <label>Content to Rate:</label>
                <div class="checkbox-group">
                  <label class="checkbox-label">
                    <input type="checkbox" id="rate-chunks" checked>
                    <span>Video Chunks <span class="item-count" id="chunks-count">(0 items)</span></span>
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" id="rate-comments" checked>
                    <span>Comments <span class="item-count" id="comments-count">(0 items)</span></span>
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" id="rate-pdfs" checked>
                    <span>PDF Excerpts <span class="item-count" id="pdfs-count">(0 items)</span></span>
                  </label>
                </div>
              </div>
              
              <details class="advanced-options">
                <summary>⚙️ Rate Limiting & Performance</summary>
                <div class="advanced-content">
                  <div class="form-group">
                    <label for="concurrent-requests">Concurrent Requests:</label>
                    <input type="number" id="concurrent-requests" class="form-control" value="5" min="1" max="20">
                    <small>⚠️ How many API calls at once (lower = more stable, 5 recommended)</small>
                  </div>
                  
                  <div class="form-group">
                    <label for="batch-size">Batch Size:</label>
                    <input type="number" id="batch-size" class="form-control" value="50" min="10" max="200">
                    <small>Items processed before progress update (doesn't affect speed)</small>
                  </div>
                  
                  <div class="form-group">
                    <label for="retry-delay">Retry Delay (seconds):</label>
                    <input type="number" id="retry-delay" class="form-control" value="2" min="1" max="10" step="0.5">
                    <small>Wait time between retries (with exponential backoff)</small>
                  </div>
                  
                  <div class="form-group">
                    <label class="checkbox-label">
                      <input type="checkbox" id="include-confidence" checked>
                      <span>Include confidence scores</span>
                    </label>
                  </div>
                </div>
              </details>
              
              <div class="cost-estimate">
                Estimated: <span id="items-estimate">0 items</span> × ~$0.00015 = <span id="cost-estimate">$0.00</span>
              </div>
              
                  <div class="button-group">
                    <button class="btn btn-primary" id="start-rating-btn">Start Rating</button>
                    <button class="btn btn-secondary" id="preview-rating-btn">🔍 Preview First 5</button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Rating Progress Section (Inline) -->
            <div id="rating-progress-section" class="rating-progress-panel" style="display: none;">
              <div class="progress-panel-header">
                <h3>⚡ Rating in Progress: <span id="progress-project-name"></span></h3>
                <button class="close-btn" id="minimize-rating-btn" title="Minimize (rating continues in background)">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                </button>
              </div>
              
              <div class="progress-section">
                <div class="progress-bar-modern">
                  <div class="progress-fill-modern" id="rating-progress-fill"></div>
                </div>
                <div class="progress-stats">
                  <span id="rating-progress-text" class="progress-stat-main">0 / 0 (0%)</span>
                  <span id="rating-time-estimate" class="progress-stat-time">Est. remaining: calculating...</span>
                </div>
              </div>
              
              <div class="rating-stream-container">
                <h4>Live Updates</h4>
                <div class="rating-stream" id="rating-stream">
                  <!-- Live updates will appear here -->
                </div>
              </div>
              
              <div class="rating-distribution-container">
                <h4>Distribution</h4>
                <div id="rating-distribution-bars"></div>
              </div>
              
              <div class="progress-actions">
                <button class="btn btn-warning btn-sm" id="pause-rating-btn">⏸ Pause</button>
                <button class="btn btn-danger btn-sm" id="cancel-rating-btn">✕ Cancel</button>
                <button class="btn btn-secondary btn-sm" id="export-current-btn">💾 Export Current</button>
              </div>
              
              <div class="progress-note">
                <small>💡 Tip: You can minimize this panel. Rating continues in the background.</small>
              </div>
            </div>
            
            <!-- Rating Project Viewer (slides in from right) -->
            <div id="rating-project-viewer" class="rating-viewer" style="display: none;">
              <div class="rating-viewer-header">
                <button class="btn btn-secondary btn-sm" id="close-rating-viewer">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                  </svg>
                  Back to Projects
                </button>
                <!-- Lineage Breadcrumbs -->
                <div id="project-lineage" class="project-lineage" style="display:none;"></div>
                <h2 id="rating-viewer-title">Project Name</h2>
                <div class="rating-viewer-actions">
                  <button class="btn btn-primary btn-sm" id="create-child-project-btn">🌳 Create Child Project</button>
                  <button class="btn btn-secondary btn-sm" id="export-project-btn">💾 Export</button>
                  <button class="btn btn-warning btn-sm" id="retry-failed-btn" style="display:none;">🔄 Retry Failed</button>
                </div>
              </div>
              
              <div class="rating-viewer-stats">
                <div class="stat-card">
                  <span class="stat-label">Total Rated</span>
                  <span class="stat-value" id="viewer-total">0</span>
                </div>
                <div class="stat-card">
                  <span class="stat-label">Success Rate</span>
                  <span class="stat-value success" id="viewer-success-rate">0%</span>
                </div>
                <div class="stat-card">
                  <span class="stat-label">Avg Score</span>
                  <span class="stat-value" id="viewer-avg-score">0.00</span>
                </div>
                <div class="stat-card">
                  <span class="stat-label">Failed</span>
                  <span class="stat-value failed" id="viewer-failed">0</span>
                </div>
              </div>
              
              <div class="rating-viewer-tabs">
                <button class="rating-tab active" data-tab="overview">📊 Overview</button>
                <button class="rating-tab" data-tab="ratings">📋 Ratings</button>
                <button class="rating-tab" data-tab="failed">❌ Failed</button>
              </div>
              
              <div class="rating-viewer-content">
                <!-- Overview Tab -->
                <div class="rating-tab-content active" id="overview-tab">
                  <div class="overview-section">
                    <h3>Research Intent</h3>
                    <div class="research-intent-box" id="viewer-research-intent"></div>
                  </div>
                  
                  <div class="overview-section">
                    <h3>Score Distribution</h3>
                    <div class="distribution-chart" id="viewer-distribution">
                      <!-- Will be populated -->
                    </div>
                  </div>
                  
                  <div class="overview-section">
                    <h3>Content Type Breakdown</h3>
                    <div class="type-breakdown" id="viewer-type-breakdown">
                      <!-- Will be populated -->
                    </div>
                  </div>
                </div>
                
                <!-- Ratings Browser Tab -->
                <div class="rating-tab-content" id="ratings-tab">
                  <div class="ratings-filter-bar">
                    <input type="text" class="search-input" id="ratings-search" placeholder="🔍 Search ratings...">
                    <select class="filter-select" id="ratings-filter-score">
                      <option value="all">All Scores</option>
                      <option value="high">High (>0.7)</option>
                      <option value="medium">Medium (0.4-0.7)</option>
                      <option value="low">Low (<0.4)</option>
                    </select>
                    <select class="filter-select" id="ratings-filter-type">
                      <option value="all">All Types</option>
                      <option value="video_chunk">Video Chunks</option>
                      <option value="comment">Comments</option>
                    </select>
                  </div>
                  
                  <div class="ratings-list" id="ratings-list">
                    <!-- Will be populated with rating cards -->
                  </div>
                </div>
                
                <!-- Failed Items Tab -->
                <div class="rating-tab-content" id="failed-tab">
                  <div class="failed-items-header">
                    <p>These items failed to be rated. You can retry them individually or all at once.</p>
                  </div>
                  <div class="failed-items-list" id="failed-items-list">
                    <!-- Will be populated with failed items -->
                  </div>
                </div>
              </div>
            </div>
          </div>
          </div>
          <!-- End Ratings Tab -->

          <!-- BWS Tab -->
          <div id="bwsTab" class="tab-content">
            <div class="bws-container">
              <!-- Header with Stats -->
              <div class="view-header">
                <div>
                  <h2>🔀 Best-Worst Scaling Experiments</h2>
                  <p class="subtitle">Compare items pairwise to generate precise rankings</p>
                </div>
                <div class="header-actions">
                  <button class="btn btn-primary" id="create-bws-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Create BWS Experiment
                  </button>
                </div>
              </div>

              <!-- Stats Summary -->
              <div class="stats-bar">
                <div class="stat-item">
                  <span class="stat-value" id="totalBWSExperiments">0</span>
                  <span class="stat-label">experiments</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value" id="totalJudgments">0</span>
                  <span class="stat-label">judgments</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value" id="aiHumanAgreement">0%</span>
                  <span class="stat-label">AI-human agreement</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value" id="totalBWSCost">$0.00</span>
                  <span class="stat-label">API cost</span>
                </div>
              </div>

              <!-- Search/Filter Bar -->
              <div class="filter-bar">
                <input type="text" id="bws-search" class="search-input" placeholder="Search experiments...">
                <select id="bws-filter-status" class="filter-select">
                  <option value="">All Statuses</option>
                  <option value="draft">Draft</option>
                  <option value="in_progress">In Progress</option>
                  <option value="completed">Completed</option>
                  <option value="paused">Paused</option>
                </select>
              </div>

              <!-- BWS Experiments Gallery -->
              <div id="bws-experiments-gallery" class="projects-gallery">
                <div class="empty-state">
                  <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                    <polyline points="7.8 2 12 5.4 16.2 2"></polyline>
                    <polyline points="7.8 22 12 18.6 16.2 22"></polyline>
                  </svg>
                  <p>No BWS experiments yet</p>
                  <p class="hint">First, create rating projects to filter your data, then run BWS experiments for fine-grained rankings</p>
                  <button class="btn btn-primary" onclick="document.getElementById('create-bws-btn').click()">
                    Create Your First Experiment
                  </button>
                </div>
              </div>

              <!-- Create BWS Experiment Modal -->
              <div id="create-bws-modal" class="modal" style="display: none;">
                <div class="modal-content modal-large">
                  <div class="modal-header">
                    <h3>Create BWS Experiment</h3>
                    <button class="close-btn" id="close-bws-modal">&times;</button>
                  </div>
                  <div class="modal-body">
                    <!-- Step 1: Choose Source Type -->
                    <div class="form-group">
                      <label>What do you want to compare?</label>
                      <div class="radio-group" style="display: flex; gap: 20px; margin-bottom: 10px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                          <input type="radio" name="bws-source-type" value="rating-project" checked>
                          <span>Items from a Rating Project</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                          <input type="radio" name="bws-source-type" value="collection">
                          <span>Items from a Collection</span>
                        </label>
                      </div>
                      <small id="bws-source-type-hint">Use rated items filtered by relevance score</small>
                    </div>

                    <!-- Rating Project Selection -->
                    <div id="bws-rating-project-section" class="form-group">
                      <label for="bws-rating-project-select">Select Rating Project:</label>
                      <select id="bws-rating-project-select" class="form-control">
                        <option value="">Choose a rating project...</option>
                      </select>
                      <small>Select a completed rating project to use as source for BWS comparisons</small>
                    </div>

                    <!-- Collection Selection -->
                    <div id="bws-collection-section" class="form-group" style="display: none;">
                      <label for="bws-collection-select">Select Collection:</label>
                      <select id="bws-collection-select" class="form-control">
                        <option value="">Choose a collection...</option>
                      </select>
                      <small>Compare items directly from a collection (without needing ratings first)</small>
                    </div>

                    <!-- Collection Content Type Selection -->
                    <div id="bws-collection-content-section" style="display: none;">
                      <div class="form-group">
                        <label>What to compare:</label>
                        <div class="checkbox-group">
                          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 8px;">
                            <input type="checkbox" id="bws-include-comments" checked>
                            <span>Comments</span>
                          </label>
                          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 8px;">
                            <input type="checkbox" id="bws-include-chunks">
                            <span>Video Chunks</span>
                          </label>
                          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="bws-include-pdfs">
                            <span>PDF Excerpts</span>
                          </label>
                        </div>
                        <small>Select which types of content to include in the comparison</small>
                      </div>
                    </div>

                    <!-- Source Info Display -->
                    <div id="bws-source-info" class="notice-box" style="display:none;">
                      <div class="info-row">
                        <strong>Source:</strong> <span id="bws-selected-source-name"></span>
                      </div>
                      <div class="info-row">
                        <strong>Total Items:</strong> <span id="bws-total-items">0</span>
                      </div>
                      <div class="info-row">
                        <strong>Item Type:</strong> <span id="bws-item-type"></span>
                      </div>
                    </div>

                    <!-- Step 2: Filter Criteria (only for rating projects) -->
                    <div id="bws-filter-section" style="display:none;">
                      <div class="form-group">
                        <label>Filter Items by Score:</label>
                        <div class="filter-row">
                          <label for="bws-min-score">Minimum Score:</label>
                          <input type="number" id="bws-min-score" class="form-control" value="0.7" min="0" max="1" step="0.1">
                          <small>Only include items with relevance score ≥ this value</small>
                        </div>
                        <div class="filter-preview">
                          <small>Filtered items: <strong id="bws-filtered-count">calculating...</strong></small>
                        </div>
                      </div>
                    </div>

                    <!-- Step 3: Experiment Configuration -->
                    <div id="bws-config-section" style="display:none;">
                      <div class="form-group">
                        <label for="bws-experiment-name">Experiment Name:</label>
                        <input type="text" id="bws-experiment-name" class="form-control" placeholder="e.g., Top Quality Comments Ranking">
                      </div>

                      <div class="form-group">
                        <label for="bws-research-intent">Comparison Criteria / Research Intent:</label>
                        <textarea id="bws-research-intent" class="form-control" rows="3"
                          placeholder="What makes one item better than another? Be specific about the quality dimension you're measuring."></textarea>
                        <small>Example: "Which comment provides the most substantive, informative content about the topic?"</small>
                      </div>

                      <div class="form-row">
                        <div class="form-group">
                          <label for="bws-tuple-size">Tuple Size:</label>
                          <select id="bws-tuple-size" class="form-control">
                            <option value="2">2 items (pairwise)</option>
                            <option value="3" selected>3 items</option>
                            <option value="4">4 items</option>
                            <option value="5">5 items</option>
                          </select>
                          <small>How many items to show per comparison</small>
                        </div>

                        <div class="form-group">
                          <label for="bws-target-appearances">Target Appearances:</label>
                          <input type="number" id="bws-target-appearances" class="form-control" value="4" min="2" max="10">
                          <small>Times each item should appear (affects total comparisons)</small>
                        </div>
                      </div>

                      <div class="form-row">
                        <div class="form-group">
                          <label for="bws-design-method">Generation Method:</label>
                          <select id="bws-design-method" class="form-control">
                            <option value="random">Random (fast, simple)</option>
                            <option value="balanced" selected>Balanced (equal coverage)</option>
                            <option value="maxdiff">MaxDiff (optimal, future)</option>
                          </select>
                          <small>How to generate comparison sets</small>
                        </div>

                        <div class="form-group">
                          <label for="bws-rater-type">Rater Type:</label>
                          <select id="bws-rater-type" class="form-control">
                            <option value="ai" selected>AI + Human (Unified Interface)</option>
                          </select>
                          <small>AI ratings (bright borders) + Your ratings (light borders) in one interface</small>
                        </div>
                      </div>

                      <div class="form-group">
                        <label for="bws-scoring-method">Scoring Method:</label>
                        <select id="bws-scoring-method" class="form-control">
                          <option value="counting" selected>Counting (simple: #best - #worst)</option>
                          <option value="bradley_terry">Bradley-Terry (probabilistic, future)</option>
                        </select>
                        <small>How to calculate final rankings</small>
                      </div>

                      <!-- Estimate Display -->
                      <div class="cost-estimate">
                        <div class="estimate-row">
                          <span>Estimated comparisons:</span>
                          <strong id="bws-estimate-tuples">0</strong>
                        </div>
                        <div class="estimate-row">
                          <span>Items to rank:</span>
                          <strong id="bws-estimate-items">0</strong>
                        </div>
                        <div class="estimate-row" id="bws-ai-cost-row" style="display:none;">
                          <span>Estimated AI cost:</span>
                          <strong id="bws-estimate-cost">$0.00</strong>
                        </div>
                      </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="button-group">
                      <button class="btn btn-secondary" id="bws-cancel-btn">Cancel</button>
                      <button class="btn btn-primary" id="bws-create-btn" disabled>Create Experiment</button>
                    </div>
                  </div>
                </div>
              </div>
              <!-- End Create BWS Modal -->

              <!-- BWS Rating Interface (Full Screen Overlay) -->
              <div id="bws-rating-interface" class="bws-rating-overlay" style="display: none;">
                <div class="bws-rating-container">
                  <!-- Header with Progress -->
                  <div class="bws-rating-header">
                    <div class="bws-rating-title">
                      <h2 id="bws-rating-exp-name">BWS Rating</h2>
                      <p id="bws-rating-exp-desc" class="subtitle"></p>
                      <p id="bws-rating-rater-info" class="subtitle" style="display: none; color: #0ea5e9; font-size: 0.85rem;"></p>
                    </div>
                    <div class="bws-rating-progress-wrapper">
                      <div class="bws-rating-progress-info">
                        <span id="bws-rating-progress-text">0 / 0 (0%)</span>
                        <div class="bws-rating-header-buttons">
                          <button id="bws-rating-pause-btn" class="btn btn-secondary" title="Pause and take a break">⏸️ Pause</button>
                          <button id="bws-rating-close-btn" class="btn btn-secondary" title="Exit rating">← Exit</button>
                        </div>
                      </div>
                      <div class="bws-rating-progress-bar">
                        <div id="bws-rating-progress-fill" class="bws-rating-progress-fill"></div>
                      </div>
                    </div>
                  </div>

                  <!-- View Controls & Filters -->
                  <div class="bws-view-controls">
                    <div class="bws-filter-group">
                      <label>View:</label>
                      <select id="bws-filter-mode" class="bws-filter-select">
                        <option value="all">All Tuples</option>
                        <option value="unrated">Unrated Only</option>
                        <option value="ai-rated">AI Rated</option>
                        <option value="human-rated">Human Rated</option>
                      </select>
                    </div>
                    <div class="bws-toggle-group">
                      <label class="bws-toggle-label">
                        <input type="checkbox" id="bws-auto-refresh" checked>
                        <span>🔄 Auto-refresh</span>
                      </label>
                      <label class="bws-toggle-label">
                        <input type="checkbox" id="bws-blind-mode">
                        <span id="bws-blind-mode-label">👁 Blind Mode: OFF</span>
                      </label>
                    </div>
                  </div>

                  <!-- AI Progress Banner (Inline, Non-Blocking) -->
                  <div id="bws-ai-progress-banner" class="bws-ai-progress-banner" style="display: none;">
                    <div class="bws-ai-progress-content">
                      <div class="bws-ai-progress-header">
                        <span class="bws-ai-progress-icon">🤖</span>
                        <span class="bws-ai-progress-title" id="bws-ai-progress-title">AI Rating in Progress</span>
                        <button id="bws-ai-progress-pause" class="btn-icon" title="Pause AI rating" style="display: none;">
                          ⏸
                        </button>
                      </div>

                      <div class="bws-ai-progress-bar-container">
                        <div class="bws-ai-progress-bar-track">
                          <div id="bws-ai-progress-bar-fill" class="bws-ai-progress-bar-fill" style="width: 0%;"></div>
                        </div>
                        <div class="bws-ai-progress-stats">
                          <span id="bws-ai-progress-count-inline">0 / 0</span>
                          <span id="bws-ai-progress-percentage-inline">0%</span>
                        </div>
                      </div>

                      <div id="bws-ai-latest-inline" class="bws-ai-latest-inline" style="display: none;">
                        <span class="latest-label">Latest:</span>
                        <span id="bws-ai-latest-text-inline"></span>
                      </div>
                    </div>
                  </div>

                  <!-- Scrollable List View -->
                  <div id="bws-list-view" class="bws-list-view">
                    <!-- Tuple cards will be dynamically inserted here -->
                  </div>

                  <!-- Single Tuple Rating View (existing, hidden by default in list mode) -->
                  <div id="bws-single-rating-view" class="bws-single-rating-view" style="display: none;">
                    <!-- Instructions -->
                    <div class="bws-rating-instructions">
                      <p><strong>Instructions:</strong> Select the <span class="text-success">BEST</span> and <span class="text-danger">WORST</span> items from the set below based on the research intent.</p>
                      <p class="text-muted">Keyboard shortcuts: <kbd>1-4</kbd> for Best, <kbd>Q-R</kbd> for Worst, <kbd>Enter</kbd> to Submit</p>
                    </div>

                    <!-- Item Cards Grid -->
                    <div id="bws-rating-items-grid" class="bws-rating-items-grid">
                      <!-- Cards will be dynamically inserted here -->
                    </div>
                  </div>

                  <!-- Navigation and Action Buttons -->
                  <div class="bws-navigation-bar">
                    <div class="bws-nav-left">
                      <button id="bws-nav-prev-btn" class="btn btn-secondary">
                        ← Previous
                      </button>
                    </div>

                    <div class="bws-nav-center">
                      <button id="bws-rating-submit-btn" class="btn btn-primary" disabled>
                        Submit Judgment
                      </button>
                      <button id="bws-rating-skip-btn" class="btn btn-secondary">
                        Skip
                      </button>
                    </div>

                    <div class="bws-nav-right">
                      <button id="bws-nav-next-btn" class="btn btn-secondary">
                        Next →
                      </button>
                    </div>
                  </div>

                  <!-- Tuple Position Indicator -->
                  <div id="bws-tuple-position" class="bws-tuple-position">
                    Tuple <span id="bws-current-index">1</span> of <span id="bws-total-count">0</span>
                  </div>

                  <!-- Loading State -->
                  <div id="bws-rating-loading" class="bws-rating-loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Loading next comparison...</p>
                  </div>
                </div>
              </div>
              <!-- End BWS Rating Interface -->

              <!-- BWS Video Detail Modal -->
              <div id="bws-video-detail-modal" class="bws-video-detail-modal" style="display: none;" onclick="if(event.target === this) closeBWSVideoDetailModal()">
                <div class="bws-video-detail-content">
                  <button class="modal-close-btn" onclick="closeBWSVideoDetailModal()" title="Close">&times;</button>

                  <h3 id="bws-modal-title">Video Detail</h3>

                  <div class="bws-modal-video-wrapper">
                    <video id="bws-modal-video" class="bws-modal-video" controls loop>
                      <source type="video/mp4">
                    </video>
                  </div>

                  <div class="bws-modal-info">
                    <div class="bws-modal-section">
                      <h4>📝 Transcript</h4>
                      <p id="bws-modal-transcript" class="bws-modal-transcript"></p>
                    </div>

                    <div class="bws-modal-section">
                      <h4>📊 Metadata</h4>
                      <div id="bws-modal-meta" class="bws-modal-meta"></div>
                    </div>
                  </div>

                  <button class="btn btn-primary" onclick="closeBWSVideoDetailModal()" style="margin-top: 1rem;">
                    ← Back to Comparison
                  </button>
                </div>
              </div>
              <!-- End BWS Video Detail Modal -->

              <!-- AI Rating Progress Overlay -->
              <div id="bws-ai-progress-overlay" class="bws-ai-progress-overlay" style="display: none;">
                <div class="bws-ai-progress-modal">
                  <button id="bws-ai-progress-close" class="modal-close-btn" title="Close (progress continues)">&times;</button>
                  <h3>🤖 AI Rating in Progress</h3>
                  <p id="bws-ai-progress-text">Processing comparisons...</p>

                  <div class="bws-ai-progress-bar">
                    <div id="bws-ai-progress-fill" class="bws-ai-progress-fill"></div>
                  </div>

                  <div class="bws-ai-progress-stats">
                    <span id="bws-ai-progress-count">0 / 0</span>
                    <span id="bws-ai-progress-percentage">0%</span>
                  </div>

                  <div id="bws-ai-latest-result" class="bws-ai-latest-result" style="display: none;">
                    <strong>Latest:</strong>
                    <div id="bws-ai-latest-text"></div>
                  </div>

                  <p class="text-muted" style="margin-top: 1rem; font-size: 0.85rem;">
                    This may take a few minutes. You can continue using the app.
                  </p>
                </div>
              </div>
              <!-- End AI Progress Overlay -->

              <!-- BWS Results View -->
              <div id="bws-results-overlay" class="bws-results-overlay" style="display: none;">
                <div class="bws-results-container">
                  <!-- Header -->
                  <div class="bws-results-header">
                    <div>
                      <h2 id="bws-results-title">BWS Results</h2>
                      <p id="bws-results-subtitle" class="subtitle"></p>
                    </div>
                    <button id="bws-results-close" class="btn btn-secondary">← Back to Experiments</button>
                  </div>

                  <!-- Stats Summary -->
                  <div class="bws-results-stats">
                    <div class="stat-card">
                      <span class="stat-label">Total Items Ranked</span>
                      <span class="stat-value" id="bws-results-total">0</span>
                    </div>
                    <div class="stat-card">
                      <span class="stat-label">Comparisons Made</span>
                      <span class="stat-value" id="bws-results-comparisons">0</span>
                    </div>
                    <div class="stat-card">
                      <span class="stat-label">Scoring Method</span>
                      <span class="stat-value" id="bws-results-method">Counting</span>
                    </div>
                  </div>

                  <!-- Export Actions and Rater Selector -->
                  <div class="bws-results-actions">
                    <div class="bws-rater-selector-wrapper" style="display: none;">
                      <label for="bws-rater-selector" style="margin-right: 0.5rem; font-weight: 600;">View Scores:</label>
                      <select id="bws-rater-selector" class="form-control" style="display: inline-block; width: auto; min-width: 200px;">
                        <option value="combined">🔀 Combined (All Raters)</option>
                      </select>
                    </div>
                    <div style="flex: 1;"></div>
                    <button id="bws-export-csv" class="btn btn-secondary">📄 Export CSV</button>
                    <button id="bws-export-json" class="btn btn-secondary">📦 Export JSON</button>
                  </div>

                  <!-- Results Table -->
                  <div class="bws-results-table-container">
                    <table class="bws-results-table">
                      <thead>
                        <tr>
                          <th data-sort="rank" class="sortable">Rank <span class="sort-arrow">↕</span></th>
                          <th>Item</th>
                          <th data-sort="score_bt" class="sortable">BT Score <span class="sort-arrow">↕</span></th>
                          <th data-sort="score" class="sortable">Count <span class="sort-arrow">↕</span></th>
                          <th data-sort="best" class="sortable">Best <span class="sort-arrow">↕</span></th>
                          <th data-sort="worst" class="sortable">Worst <span class="sort-arrow">↕</span></th>
                          <th data-sort="appearances" class="sortable">Appearances <span class="sort-arrow">↕</span></th>
                        </tr>
                      </thead>
                      <tbody id="bws-results-tbody">
                        <!-- Results will be inserted here -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              <!-- End BWS Results View -->

              <!-- Video Chunk Preview Modal -->
              <div id="bws-video-modal" class="modal" style="display: none;">
                <div class="modal-content modal-large">
                  <div class="modal-header">
                    <h3 id="bws-video-modal-title">Video Chunk</h3>
                    <button class="modal-close-btn" onclick="closeBWSVideoModal()">&times;</button>
                  </div>
                  <div class="modal-body">
                    <div class="video-preview-container">
                      <video id="bws-video-player" controls style="width: 100%; border-radius: 8px; background: #000;">
                        Your browser does not support the video tag.
                      </video>
                    </div>
                    <div class="bws-video-info">
                      <h4>Transcript</h4>
                      <p id="bws-video-transcript" style="line-height: 1.6; color: var(--text-secondary);"></p>
                      <div class="bws-video-meta">
                        <span id="bws-video-time"></span>
                        <span id="bws-video-score"></span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- End Video Modal -->

            </div>
          </div>
          <!-- End BWS Tab -->

          <!-- Dashboard Tab -->
          <div id="dashboardTab" class="tab-content">
            <div class="dashboard-container">
              <!-- Header -->
              <div class="view-header">
                <div>
                  <h2>📈 AI Analysis Dashboard</h2>
                  <p class="subtitle">Overview of your rating projects and BWS experiments</p>
                </div>
              </div>

              <!-- Combined Stats -->
              <div class="stats-bar stats-bar-wide">
                <div class="stat-item">
                  <span class="stat-value" id="dash-total-projects">0</span>
                  <span class="stat-label">rating projects</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value" id="dash-total-bws">0</span>
                  <span class="stat-label">BWS experiments</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value" id="dash-total-items">0</span>
                  <span class="stat-label">items rated</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value" id="dash-total-judgments">0</span>
                  <span class="stat-label">BWS judgments</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value" id="dash-success-rate">0%</span>
                  <span class="stat-label">success rate</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value" id="dash-total-cost">$0.00</span>
                  <span class="stat-label">total cost</span>
                </div>
              </div>

              <!-- Quick Access Cards -->
              <div class="quick-access-grid">
                <div class="quick-access-card" onclick="document.querySelector('[data-tab=ratings]').click()">
                  <div class="quick-icon">🎯</div>
                  <h3>Rating Projects</h3>
                  <div class="quick-stat">
                    <span class="quick-value" id="quick-projects">0</span>
                    <span class="quick-label">total</span>
                  </div>
                  <div class="quick-actions">
                    <span class="link-text">View All →</span>
                  </div>
                </div>

                <div class="quick-access-card" onclick="document.querySelector('[data-tab=bws]').click()">
                  <div class="quick-icon">🔀</div>
                  <h3>BWS Experiments</h3>
                  <div class="quick-stat">
                    <span class="quick-value" id="quick-bws">0</span>
                    <span class="quick-label">total</span>
                  </div>
                  <div class="quick-actions">
                    <span class="link-text">View All →</span>
                  </div>
                </div>

                <div class="quick-access-card" onclick="document.querySelector('[data-view=collections]').click()">
                  <div class="quick-icon">📦</div>
                  <h3>Collections</h3>
                  <div class="quick-stat">
                    <span class="quick-value" id="quick-collections">0</span>
                    <span class="quick-label">total</span>
                  </div>
                  <div class="quick-actions">
                    <span class="link-text">View All →</span>
                  </div>
                </div>
              </div>

              <!-- Recent Activity Feed -->
              <div class="activity-feed">
                <h3>Recent Activity</h3>
                <div id="activity-feed-list" class="activity-list">
                  <div class="empty-state-small">
                    <p>No recent activity</p>
                  </div>
                </div>
              </div>

              <!-- Workflow Navigator -->
              <div class="workflow-guide">
                <h3>Recommended Workflow</h3>
                <div class="workflow-steps">
                  <div class="workflow-step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                      <h4>Collect Data</h4>
                      <p>Search YouTube and gather videos with comments</p>
                      <button class="btn btn-sm" onclick="document.querySelector('[data-view=youtube]').click()">Go to YouTube →</button>
                    </div>
                  </div>
                  <div class="workflow-arrow">→</div>
                  <div class="workflow-step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                      <h4>Rate Relevance</h4>
                      <p>Use AI to filter items by relevance</p>
                      <button class="btn btn-sm" onclick="document.querySelector('[data-tab=ratings]').click()">Create Rating Project →</button>
                    </div>
                  </div>
                  <div class="workflow-arrow">→</div>
                  <div class="workflow-step">
                    <div class="step-number">3</div>
                    <div class="step-content">
                      <h4>Refine & Filter</h4>
                      <p>Create child projects with high-scoring items</p>
                    </div>
                  </div>
                  <div class="workflow-arrow">→</div>
                  <div class="workflow-step">
                    <div class="step-number">4</div>
                    <div class="step-content">
                      <h4>Run BWS</h4>
                      <p>Generate precise rankings with comparisons</p>
                      <button class="btn btn-sm" onclick="document.querySelector('[data-tab=bws]').click()">Create BWS Experiment →</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- End Dashboard Tab -->

        </div>
        <!-- End AI Analysis View -->

        <!-- Export View -->
        <div id="exportView" class="view">
          <h2>Export Data</h2>
          <div class="export-options">
            <div class="export-format">
              <h3>Export to CARDS Format</h3>
              <p>Export your collected data in CARDS 2.0 format for use with Variable Resolution BWS rating system.</p>
              <button id="exportCardsBtn" class="btn btn-primary">Export to CARDS</button>
            </div>
            <div class="export-format">
              <h3>Export to CSV</h3>
              <p>Export data as CSV files for analysis in Excel, R, or Python.</p>
              <button id="exportCsvBtn" class="btn">Export to CSV</button>
            </div>
            <div class="export-format">
              <h3>Export to Supabase</h3>
              <p>Upload directly to your Supabase instance for online rating.</p>
              <button id="exportSupabaseBtn" class="btn">Export to Supabase</button>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal" style="display: none;">
      <div class="modal-content">
        <h2>Settings</h2>
        <div class="settings-form">
          <h3>API Configuration</h3>
          <div class="form-group">
            <label for="youtubeApiKey">YouTube API Key</label>
            <input type="password" id="youtubeApiKey" placeholder="Enter your YouTube Data API v3 key" />
            <small>Get your API key from <a href="https://console.cloud.google.com/apis/library/youtube.googleapis.com" target="_blank">Google Cloud Console</a></small>
          </div>

          <div class="form-group">
            <label>API Key Status</label>
            <div class="api-status">
              <span id="apiKeyStatus" class="status-indicator">Not Set</span>
              <button id="testApiBtn" class="btn btn-sm">Test API Key</button>
            </div>
          </div>

          <div class="form-group">
            <label for="geminiApiKey">Gemini API Key (for AI Analysis)</label>
            <input type="password" id="geminiApiKey" placeholder="Enter your Gemini API key" />
            <small>Get your API key from <a href="https://aistudio.google.com/apikey" target="_blank">Google AI Studio</a></small>
          </div>

          <div class="form-group">
            <label>Gemini API Status</label>
            <div class="api-status">
              <span id="geminiApiStatus" class="status-indicator">Not Set</span>
              <button id="testGeminiBtn" class="btn btn-sm">Test Gemini</button>
            </div>
          </div>
          
          <h3>Storage Settings</h3>
          <div class="form-group">
            <label for="outputDir">Output Directory</label>
            <div class="input-group">
              <input type="text" id="outputDir" readonly placeholder="Select output directory" />
              <button id="selectDirBtn" class="btn">Browse</button>
            </div>
          </div>

          <div class="form-group">
            <label for="storageLimit">Storage Limit (GB)</label>
            <input type="number" id="storageLimit" value="50" min="1" max="1000" />
            <small>Stop collection when this much disk space is used</small>
          </div>

          <h3>Supabase Integration (Optional)</h3>
          <div class="form-group">
            <label for="supabaseUrl">Supabase URL</label>
            <input type="text" id="supabaseUrl" placeholder="https://your-project.supabase.co" />
          </div>

          <div class="form-group">
            <label for="supabaseKey">Supabase Anon Key</label>
            <input type="password" id="supabaseKey" placeholder="Your Supabase anonymous key" />
          </div>

          <h3>Advanced Settings</h3>
          <div class="form-group">
            <label for="concurrency">Concurrent Downloads</label>
            <input type="number" id="concurrency" value="3" min="1" max="10" />
            <small>Number of simultaneous video downloads</small>
          </div>

          <div class="form-group checkbox-group">
            <label>
              <input type="checkbox" id="autoRetry" checked />
              <span>Auto-retry failed downloads</span>
            </label>
          </div>

          <div class="form-group checkbox-group">
            <label>
              <input type="checkbox" id="enableLogging" checked />
              <span>Enable detailed logging</span>
            </label>
          </div>
        </div>
        <div class="modal-actions">
          <button id="saveSettingsBtn" class="btn btn-primary">Save Settings</button>
          <button id="closeSettingsBtn" class="btn">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Merge Modal -->
  <div id="createMergeModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h2>Create Merged Collection</h2>
        <button class="modal-close" onclick="document.getElementById('createMergeModal').style.display='none'">&times;</button>
      </div>

      <div class="modal-body">
        <div class="form-group">
          <label for="mergeName">Merge Name *</label>
          <input type="text" id="mergeName" placeholder="e.g., All Dog Studies Combined" required />
          <small>A descriptive name for this merged collection</small>
        </div>

        <div class="form-group">
          <label for="mergeDescription">Description (Optional)</label>
          <textarea id="mergeDescription" rows="3" placeholder="Describe the purpose of this merge..."></textarea>
        </div>

        <div class="form-group">
          <label>Select Collections to Merge *</label>
          <div id="mergeCollectionsList" class="collection-checklist">
            <div class="loading-spinner">Loading collections...</div>
          </div>
          <small>Select at least 2 collections to merge</small>
        </div>

        <div id="mergePreview" class="merge-preview" style="display: none;">
          <h4>Merge Preview</h4>
          <div class="preview-stats">
            <div class="stat-item">
              <span class="stat-label">Collections:</span>
              <span class="stat-value" id="previewCollectionCount">0</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Total Videos:</span>
              <span class="stat-value" id="previewVideoCount">~0</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Total Comments:</span>
              <span class="stat-value" id="previewCommentCount">~0</span>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button id="confirmCreateMergeBtn" class="btn btn-primary" disabled>Create Merge</button>
        <button class="btn" onclick="document.getElementById('createMergeModal').style.display='none'">Cancel</button>
      </div>
    </div>
  </div>

  <!-- View Merge Modal -->
  <div id="viewMergeModal" class="modal" style="display: none;">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h2 id="viewMergeName">Merged Collection</h2>
        <button class="modal-close" onclick="document.getElementById('viewMergeModal').style.display='none'">&times;</button>
      </div>

      <div class="modal-body">
        <div id="viewMergeContent">
          <!-- Dynamically populated -->
        </div>
      </div>

      <div class="modal-actions">
        <button id="deleteMergeBtn" class="btn btn-danger">Delete Merge</button>
        <button class="btn" onclick="document.getElementById('viewMergeModal').style.display='none'">Close</button>
      </div>
    </div>
  </div>

  <script src="src/components/fixed-tool-checker.js"></script>
  <script src="src/components/tool-installer.js"></script>
  <script src="src/components/collection-viewer.js"></script>
  <script src="src/components/enhanced-viewer.js"></script>
  <script src="src/components/gallery-viewer.js"></script>
  <script src="src/components/modern-single-page.js"></script>
  <script src="src/components/merge-manager.js"></script>
  <!-- Stubs removed - using real APIs now -->
  <script src="src/components/folder-browser.js"></script>
  <script src="src/components/pdf-excerpt-viewer.js"></script>
  <script src="src/bws-manager.js"></script>
  <script src="src/renderer-advanced.js"></script>
</body>
</html>